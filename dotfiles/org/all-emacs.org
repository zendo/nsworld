#+TITLE: Emacs literate configuration
#+AUTHOR: zendo
#+DATE: 03/2025
#+STARTUP: overview indent
#+PROPERTY: header-args:emacs-lisp :results silent :tangle "~/.config/emacs/post-init.el"
#+AUTO_TANGLE: t

* early-init
https://github.com/jamescherti/minimal-emacs.d minimal-emacs.d
Release: 1.3.1

curl -sL https://github.com/jamescherti/minimal-emacs.d/raw/refs/heads/main/early-init.el | wl-copy
#+begin_src emacs-lisp :tangle "~/.config/emacs/early-init.el"
;;; early-init.el --- Early Init -*- lexical-binding: t; -*-

;; Author: James Cherti
;; URL: https://github.com/jamescherti/minimal-emacs.d
;; Package-Requires: ((emacs "29.1"))
;; Keywords: maint
;; Version: 1.3.0
;; SPDX-License-Identifier: GPL-3.0-or-later

;;; Commentary:
;; The minimal-emacs.d project is a lightweight and optimized Emacs base
;; (init.el and early-init.el) that gives you full control over your
;; configuration. It provides better defaults, an optimized startup, and a clean
;; foundation for building your own vanilla Emacs setup.
;;
;; Building the minimal-emacs.d init.el and early-init.el was the result of
;; extensive research and testing to fine-tune the best parameters and
;; optimizations for an Emacs configuration.
;;
;; Do not modify this file; instead, modify pre-early-init.el or
;; post-early-init.el.

;;; Code:

;;; Internal variables

;; Backup of `gc-cons-threshold' and `gc-cons-percentage' before startup.
(defvar minimal-emacs--backup-gc-cons-threshold gc-cons-threshold)
(defvar minimal-emacs--backup-gc-cons-percentage gc-cons-percentage)

;; Temporarily raise the garbage collection threshold to its maximum value.
;; It will be restored later to controlled values.
(setq gc-cons-threshold most-positive-fixnum)
(setq gc-cons-percentage 1.0)

;;; Variables

(defvar minimal-emacs-ui-features '()
  "List of user interface features to enable in minimal Emacs setup.
This variable holds a list of Emacs UI features that can be enabled:
- context-menu (Enables the context menu in graphical environments.)
- tool-bar (Enables the tool bar in graphical environments.)
- menu-bar (Enables the menu bar in graphical environments.)
- dialogs (Enables both file dialogs and dialog boxes.)
- tooltips (Enables tooltips.)")

(defvar minimal-emacs-frame-title-format "%b – Emacs"
  "Template for displaying the title bar of visible and iconified frame.")

(defvar minimal-emacs-debug (bound-and-true-p init-file-debug)
  "Non-nil to enable debug.")

(defvar minimal-emacs-optimize-startup-gc t
  "If non-nil, increase `gc-cons-threshold' during startup to reduce pauses.
After Emacs finishes loading, `gc-cons-threshold' is restored to the value
stored in `minimal-emacs-gc-cons-threshold'.")

(defvar minimal-emacs-gc-cons-threshold (* 32 1024 1024)
  "Value to which `gc-cons-threshold' is set after Emacs startup.
Ignored if `minimal-emacs-optimize-startup-gc' is nil.")

(defvar minimal-emacs-gc-cons-percentage gc-cons-percentage
  "Value to which `gc-cons-percentage' is set after Emacs startup.
Ignored if `minimal-emacs-optimize-startup-gc' is nil.")

(defvar minimal-emacs-gc-cons-threshold-restore-delay nil
  "Number of seconds to wait before restoring `gc-cons-threshold'.")

(defvar minimal-emacs-optimize-file-name-handler-alist t
  "Enable optimization of `file-name-handler-alist'.
When non-nil, this variable activates optimizations to reduce file name handler
lookups during Emacs startup.")

(defvar minimal-emacs-disable-mode-line-during-startup t
  "Disable the mode line during startup.
This reduces visual clutter and slightly enhances startup performance. The
tradeoff is that the mode line is hidden during the startup phase.")

(defvar minimal-emacs-package-initialize-and-refresh t
  "Whether to automatically initialize and refresh packages.
When set to non-nil, Emacs will automatically call `package-initialize' and
`package-refresh-contents' to set up and update the package system.")

(defvar minimal-emacs-setup-native-compilation t
  "Controls whether native compilation settings are enabled during setup.
When non-nil, the following variables are set to non-nil to enable
native compilation features:
- `native-comp-deferred-compilation'
- `native-comp-jit-compilation'
- `package-native-compile'
If nil, these variables are left at their default values and are not
modified during setup.")

(defvar minimal-emacs-inhibit-redisplay-during-startup nil
  "Suppress redisplay during startup to improve performance.
This prevents visual updates while Emacs initializes. The tradeoff is that you
won't see the progress or activities during the startup process.")

(defvar minimal-emacs-inhibit-message-during-startup nil
  "Suppress startup messages for a cleaner experience.
This slightly enhances performance. The tradeoff is that you won't be informed
of the progress or any relevant activities during startup.")

(defvar minimal-emacs-user-directory user-emacs-directory
  "Directory beneath minimal-emacs.d files are placed.
Note that this should end with a directory separator.")

;;; Load pre-early-init.el

;; Prefer loading newer compiled files
(setq load-prefer-newer t)
(setq debug-on-error minimal-emacs-debug)

(defvar minimal-emacs--success nil)
(defun minimal-emacs--check-success ()
  "Verify that the Emacs configuration has loaded successfully."
  (unless minimal-emacs--success
    (cond
     ((or (file-exists-p (expand-file-name "~/.emacs.el"))
          (file-exists-p (expand-file-name "~/.emacs")))
      (error "Emacs ignored loading 'init.el'. Please ensure that files such as ~/.emacs or ~/.emacs.el do not exist, as they may be preventing Emacs from loading the 'init.el' file"))

     (t
      (error "Configuration error. Debug by starting Emacs with: emacs --debug-init")))))
(add-hook 'emacs-startup-hook #'minimal-emacs--check-success 102)

(defvar minimal-emacs-load-compiled-init-files nil
  "If non-nil, attempt to load byte-compiled .elc for init files.
This will enable minimal-emacs to load byte-compiled or possibly native-compiled
init files for the following initialization files: pre-init.el, post-init.el,
pre-early-init.el, and post-early-init.el.")

(defun minimal-emacs--remove-el-file-suffix (filename)
  "Remove the Elisp file suffix from FILENAME and return it (.el, .el.gz...)."
  (let ((suffixes (mapcar (lambda (ext) (concat ".el" ext))
                          load-file-rep-suffixes)))
    (catch 'done
      (dolist (suffix suffixes filename)
        (when (string-suffix-p suffix filename)
          (setq filename (substring filename 0 (- (length suffix))))
          (throw 'done t))))
    filename))

(defun minimal-emacs-load-user-init (filename)
  "Execute a file of Lisp code named FILENAME."
  (let ((init-file (expand-file-name filename
                                     minimal-emacs-user-directory)))
    (if (not minimal-emacs-load-compiled-init-files)
        (load init-file :no-error (not init-file-debug) :nosuffix)
      ;; Remove the file suffix (.el, .el.gz, etc.) to let the `load' function
      ;; select between .el and .elc files.
      (setq init-file (minimal-emacs--remove-el-file-suffix init-file))
      (load init-file :no-error (not init-file-debug)))))

(minimal-emacs-load-user-init "pre-early-init.el")

(setq custom-theme-directory
      (expand-file-name "themes/" minimal-emacs-user-directory))

(setq custom-file (expand-file-name "custom.el" minimal-emacs-user-directory))

;;; Garbage collection
;; Garbage collection significantly affects startup times. This setting delays
;; garbage collection during startup but will be reset later.

(setq garbage-collection-messages minimal-emacs-debug)

(defun minimal-emacs--restore-gc-values ()
  "Restore garbage collection values to minimal-emacs.d values."
  (setq gc-cons-threshold minimal-emacs-gc-cons-threshold)
  (setq gc-cons-percentage minimal-emacs-gc-cons-percentage))

(defun minimal-emacs--restore-gc ()
  "Restore garbage collection settings."
  (if (bound-and-true-p minimal-emacs-gc-cons-threshold-restore-delay)
      ;; Defer garbage collection during initialization to avoid 2 collections.
      (run-with-timer minimal-emacs-gc-cons-threshold-restore-delay nil
                      #'minimal-emacs--restore-gc-values)
    (minimal-emacs--restore-gc-values)))

(if minimal-emacs-optimize-startup-gc
    ;; `gc-cons-threshold' is managed by minimal-emacs.d
    (add-hook 'emacs-startup-hook #'minimal-emacs--restore-gc 105)
  ;; gc-cons-threshold is not managed by minimal-emacs.d.
  (when (= gc-cons-threshold most-positive-fixnum)
    (setq gc-cons-threshold minimal-emacs--backup-gc-cons-threshold)
    (setq gc-cons-percentage minimal-emacs--backup-gc-cons-percentage)))

;;; Native compilation and Byte compilation

(if (and (featurep 'native-compile)
         (fboundp 'native-comp-available-p)
         (native-comp-available-p))
    (when minimal-emacs-setup-native-compilation
      ;; Activate `native-compile'
      (setq package-native-compile t))
  ;; Deactivate the `native-compile' feature if it is not available
  (setq features (delq 'native-compile features)))

(setq native-comp-warning-on-missing-source minimal-emacs-debug
      native-comp-async-report-warnings-errors (or minimal-emacs-debug 'silent))

(setq jka-compr-verbose minimal-emacs-debug)
(setq byte-compile-warnings minimal-emacs-debug
      byte-compile-verbose minimal-emacs-debug)

;;; Miscellaneous

(set-language-environment "UTF-8")

;; Set-language-environment sets default-input-method, which is unwanted.
(setq default-input-method nil)

;; Increase how much is read from processes in a single chunk
(setq read-process-output-max (* 2 1024 1024))  ; 1024kb

(setq process-adaptive-read-buffering nil)

;; Don't ping things that look like domain names.
(setq ffap-machine-p-known 'reject)

(setq warning-minimum-level (if minimal-emacs-debug :warning :error))
(setq warning-suppress-types '((lexical-binding)))

(when minimal-emacs-debug
  (setq message-log-max 16384))

;; In PGTK, this timeout introduces latency. Reducing it from the default 0.1
;; improves responsiveness of childframes and related packages.
(when (boundp 'pgtk-wait-for-event-timeout)
  (setq pgtk-wait-for-event-timeout 0.001))

;; Disable warnings from the legacy advice API. They aren't useful.
(setq ad-redefinition-action 'accept)

;;; Performance: Miscellaneous options

;; Font compacting can be very resource-intensive, especially when rendering
;; icon fonts on Windows. This will increase memory usage.
(setq inhibit-compacting-font-caches t)

(when (and (not (daemonp)) (not noninteractive))
  ;; Resizing the Emacs frame can be costly when changing the font. Disable this
  ;; to improve startup times with fonts larger than the system default.
  (setq frame-resize-pixelwise t)

  ;; Without this, Emacs will try to resize itself to a specific column size
  (setq frame-inhibit-implied-resize t)

  ;; A second, case-insensitive pass over `auto-mode-alist' is time wasted.
  ;; No second pass of case-insensitive search over auto-mode-alist.
  (setq auto-mode-case-fold nil)

  ;; Reduce *Message* noise at startup. An empty scratch buffer (or the
  ;; dashboard) is more than enough, and faster to display.
  (setq inhibit-startup-screen t
        inhibit-startup-echo-area-message user-login-name)
  (setq initial-buffer-choice nil
        inhibit-startup-buffer-menu t
        inhibit-x-resources t)

  ;; Disable bidirectional text scanning for a modest performance boost.
  (setq-default bidi-display-reordering 'left-to-right
                bidi-paragraph-direction 'left-to-right)

  ;; Give up some bidirectional functionality for slightly faster re-display.
  (setq bidi-inhibit-bpa t)

  ;; Remove "For information about GNU Emacs..." message at startup
  (advice-add 'display-startup-echo-area-message :override #'ignore)

  ;; Suppress the vanilla startup screen completely. We've disabled it with
  ;; `inhibit-startup-screen', but it would still initialize anyway.
  (advice-add 'display-startup-screen :override #'ignore)

  ;; The initial buffer is created during startup even in non-interactive
  ;; sessions, and its major mode is fully initialized. Modes like `text-mode',
  ;; `org-mode', or even the default `lisp-interaction-mode' load extra packages
  ;; and run hooks, which can slow down startup.
  ;;
  ;; Using `fundamental-mode' for the initial buffer to avoid unnecessary
  ;; startup overhead.
  (setq initial-major-mode 'fundamental-mode
        initial-scratch-message nil)

  (unless minimal-emacs-debug
    ;; Unset command line options irrelevant to the current OS. These options
    ;; are still processed by `command-line-1` but have no effect.
    (unless (eq system-type 'darwin)
      (setq command-line-ns-option-alist nil))
    (unless (memq initial-window-system '(x pgtk))
      (setq command-line-x-option-alist nil))))

;;; Performance: File-name-handler-alist

(defvar minimal-emacs--old-file-name-handler-alist (default-toplevel-value
                                                    'file-name-handler-alist))

(defun minimal-emacs--respect-file-handlers (fn args-left)
  "Respect file handlers.
FN is the function and ARGS-LEFT is the same argument as `command-line-1'.
Emacs processes command-line files very early in startup. These files may
include special paths like TRAMP paths, so restore `file-name-handler-alist' for
this stage of initialization."
  (let ((file-name-handler-alist (if args-left
                                     minimal-emacs--old-file-name-handler-alist
                                   file-name-handler-alist)))
    (funcall fn args-left)))

(defun minimal-emacs--restore-file-name-handler-alist ()
  "Restore `file-name-handler-alist'."
  (set-default-toplevel-value
   'file-name-handler-alist
   ;; Merge instead of overwrite to preserve any changes made since startup.
   (delete-dups (append file-name-handler-alist
                        minimal-emacs--old-file-name-handler-alist))))

(when (and minimal-emacs-optimize-file-name-handler-alist
           (not (daemonp))
           (not minimal-emacs-debug))
  ;; Determine the state of bundled libraries using calc-loaddefs.el. If
  ;; compressed, retain the gzip handler in `file-name-handler-alist`. If
  ;; compiled or neither, omit the gzip handler during startup for improved
  ;; startup and package load time.
  (set-default-toplevel-value
   'file-name-handler-alist
   (if (locate-file-internal "calc-loaddefs.el" load-path)
       nil
     (list (rassq 'jka-compr-handler
                  minimal-emacs--old-file-name-handler-alist))))

  ;; Ensure the new value persists through any current let-binding.
  (put 'file-name-handler-alist 'initial-value
       minimal-emacs--old-file-name-handler-alist)

  ;; Emacs processes command-line files very early in startup. These files may
  ;; include special paths TRAMP. Restore `file-name-handler-alist'.
  (advice-add 'command-line-1 :around #'minimal-emacs--respect-file-handlers)

  (add-hook 'emacs-startup-hook #'minimal-emacs--restore-file-name-handler-alist
            101))

;;; Performance: Inhibit redisplay

(defun minimal-emacs--reset-inhibit-redisplay ()
  "Reset inhibit redisplay."
  (setq-default inhibit-redisplay nil)
  (remove-hook 'post-command-hook #'minimal-emacs--reset-inhibit-redisplay))

(when (and minimal-emacs-inhibit-redisplay-during-startup
           (not (daemonp))
           (not noninteractive)
           (not minimal-emacs-debug))
  ;; Suppress redisplay and redraw during startup to avoid delays and
  ;; prevent flashing an unstyled Emacs frame.
  (setq-default inhibit-redisplay t)
  (add-hook 'post-command-hook #'minimal-emacs--reset-inhibit-redisplay -100))

;;; Performance: Inhibit message

(defun minimal-emacs--reset-inhibit-message ()
  "Reset inhibit message."
  (setq-default inhibit-message nil)
  (remove-hook 'post-command-hook #'minimal-emacs--reset-inhibit-message))

(when (and minimal-emacs-inhibit-message-during-startup
           (not (daemonp))
           (not noninteractive)
           (not minimal-emacs-debug))
  (setq-default inhibit-message t)
  (add-hook 'post-command-hook #'minimal-emacs--reset-inhibit-message -100))

;;; Performance: Disable mode-line during startup

(when (and minimal-emacs-disable-mode-line-during-startup
           (not (daemonp))
           (not noninteractive)
           (not minimal-emacs-debug))
  (put 'mode-line-format
       'initial-value (default-toplevel-value 'mode-line-format))
  (setq-default mode-line-format nil)
  (dolist (buf (buffer-list))
    (with-current-buffer buf
      (setq mode-line-format nil))))

;;; Restore values

(defun minimal-emacs--startup-load-user-init-file (fn &rest args)
  "Advice to reset `mode-line-format'. FN and ARGS are the function and args."
  (unwind-protect
      ;; Start up as normal
      (apply fn args)
    ;; If we don't undo inhibit-{message, redisplay} and there's an error, we'll
    ;; see nothing but a blank Emacs frame.
    (when minimal-emacs-inhibit-message-during-startup
      (setq-default inhibit-message nil))
    (when minimal-emacs-inhibit-redisplay-during-startup
      (setq-default inhibit-redisplay nil))
    ;; Restore the mode-line
    (when minimal-emacs-disable-mode-line-during-startup
      (unless (default-toplevel-value 'mode-line-format)
        (setq-default mode-line-format (get 'mode-line-format
                                            'initial-value))))))

(advice-add 'startup--load-user-init-file :around
            #'minimal-emacs--startup-load-user-init-file)

;;; UI elements

(setq frame-title-format minimal-emacs-frame-title-format
      icon-title-format minimal-emacs-frame-title-format)

;; Disable startup screens and messages
(setq inhibit-splash-screen t)

;; I intentionally avoid calling `menu-bar-mode', `tool-bar-mode', and
;; `scroll-bar-mode' because manipulating frame parameters can trigger or queue
;; a superfluous and potentially expensive frame redraw at startup, depending
;; on the window system. The variables must also be set to `nil' so users don't
;; have to call the functions twice to re-enable them.
(unless (memq 'menu-bar minimal-emacs-ui-features)
  (push '(menu-bar-lines . 0) default-frame-alist)
  (unless (memq window-system '(mac ns))
    (setq menu-bar-mode nil)))

(defun minimal-emacs--setup-toolbar (&rest _)
  "Setup the toolbar."
  (when (fboundp 'tool-bar-setup)
    (advice-remove 'tool-bar-setup #'ignore)
    (when (bound-and-true-p tool-bar-mode)
      (funcall 'tool-bar-setup))))

(when (and (not (daemonp))
           (not noninteractive))
  (when (fboundp 'tool-bar-setup)
    ;; Temporarily override the tool-bar-setup function to prevent it from
    ;; running during the initial stages of startup
    (advice-add 'tool-bar-setup :override #'ignore)

    (advice-add 'startup--load-user-init-file :after
                #'minimal-emacs--setup-toolbar)))

(unless (memq 'tool-bar minimal-emacs-ui-features)
  (push '(tool-bar-lines . 0) default-frame-alist)
  (setq tool-bar-mode nil))

(setq default-frame-scroll-bars 'right)
(push '(vertical-scroll-bars) default-frame-alist)
(push '(horizontal-scroll-bars) default-frame-alist)
(setq scroll-bar-mode nil)

(unless (memq 'tooltips minimal-emacs-ui-features)
  (when (bound-and-true-p tooltip-mode)
    (tooltip-mode -1)))

;; Disable GUIs because they are inconsistent across systems, desktop
;; environments, and themes, and they don't match the look of Emacs.
(unless (memq 'dialogs minimal-emacs-ui-features)
  (setq use-file-dialog nil)
  (setq use-dialog-box nil))

;;; Security
(setq gnutls-verify-error t)  ; Prompts user if there are certificate issues
(setq tls-checktrust t)  ; Ensure SSL/TLS connections undergo trust verification
(setq gnutls-min-prime-bits 3072)  ; Stronger GnuTLS encryption

;;; package.el
(setq use-package-compute-statistics minimal-emacs-debug)

;; Setting use-package-expand-minimally to (t) results in a more compact output
;; that emphasizes performance over clarity.
(setq use-package-expand-minimally (not minimal-emacs-debug))

(setq package-quickstart-file
      (expand-file-name "package-quickstart.el" user-emacs-directory))
(setq use-package-minimum-reported-time (if minimal-emacs-debug 0 0.1))
(setq use-package-verbose minimal-emacs-debug)
(setq package-enable-at-startup nil)  ; Let the init.el file handle this
(setq use-package-always-ensure t)
(setq use-package-enable-imenu-support t)
(setq package-archives '(("melpa"        . "https://melpa.org/packages/")
                         ("gnu"          . "https://elpa.gnu.org/packages/")
                         ("nongnu"       . "https://elpa.nongnu.org/nongnu/")
                         ("melpa-stable" . "https://stable.melpa.org/packages/")))
(setq package-archive-priorities '(("gnu"    . 99)
                                   ("nongnu" . 80)
                                   ("melpa"  . 70)
                                   ("melpa-stable" . 50)))

;;; Load post-early-init.el
(minimal-emacs-load-user-init "post-early-init.el")

;; Local variables:
;; byte-compile-warnings: (not obsolete free-vars)
;; End:

;;; early-init.el ends here
#+end_src

* init.el
curl -sL https://github.com/jamescherti/minimal-emacs.d/raw/refs/heads/main/init.el | wl-copy
#+begin_src emacs-lisp :tangle "~/.config/emacs/init.el"
;;; init.el --- Init -*- lexical-binding: t; -*-

;; Author: James Cherti
;; URL: https://github.com/jamescherti/minimal-emacs.d
;; Package-Requires: ((emacs "29.1"))
;; Keywords: maint
;; Version: 1.3.0
;; SPDX-License-Identifier: GPL-3.0-or-later

;;; Commentary:
;; The minimal-emacs.d project is a lightweight and optimized Emacs base
;; (init.el and early-init.el) that gives you full control over your
;; configuration. It provides better defaults, an optimized startup, and a clean
;; foundation for building your own vanilla Emacs setup.
;;
;; Building the minimal-emacs.d init.el and early-init.el was the result of
;; extensive research and testing to fine-tune the best parameters and
;; optimizations for an Emacs configuration.
;;
;; Do not modify this file; instead, modify pre-init.el or post-init.el.

;;; Code:

;;; Load pre-init.el
(if (fboundp 'minimal-emacs-load-user-init)
    (minimal-emacs-load-user-init "pre-init.el")
  (error "The early-init.el file failed to loaded"))

;;; Before package

;; Ask the user whether to terminate asynchronous compilations on exit.
;; This prevents native compilation from leaving temporary files in /tmp.
(setq native-comp-async-query-on-exit t)

;; Allow for shorter responses: "y" for yes and "n" for no.
(setq read-answer-short t)
(if (boundp 'use-short-answers)
    (setq use-short-answers t)
  (advice-add 'yes-or-no-p :override #'y-or-n-p))

;;; Undo/redo

(setq undo-limit (* 13 160000)
      undo-strong-limit (* 13 240000)
      undo-outer-limit (* 13 24000000))

;;; package.el

(when (bound-and-true-p minimal-emacs-package-initialize-and-refresh)
  ;; Initialize and refresh package contents again if needed
  (package-initialize)
  ;; Install use-package if necessary
  (unless (package-installed-p 'use-package)
    (unless (seq-empty-p package-archive-contents)
      (package-refresh-contents))
    (package-install 'use-package))

  ;; Ensure use-package is available
  (require 'use-package))

;;; Minibuffer

;; Allow nested minibuffers
(setq enable-recursive-minibuffers t)

;; Keep the cursor out of the read-only portions of the.minibuffer
(setq minibuffer-prompt-properties
      '(read-only t intangible t cursor-intangible t face minibuffer-prompt))
(add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)

;;; User interface

;; By default, Emacs "updates" its ui more often than it needs to
(setq which-func-update-delay 1.0)
(setq idle-update-delay which-func-update-delay)  ;; Obsolete in >= 30.1

(defalias #'view-hello-file #'ignore)  ; Never show the hello file

;; No beeping or blinking
(setq visible-bell nil)
(setq ring-bell-function #'ignore)

;;; Show-paren

(setq show-paren-delay 0.1
      show-paren-highlight-openparen t
      show-paren-when-point-inside-paren t
      show-paren-when-point-in-periphery t)

;;; Misc

(setq custom-buffer-done-kill t)

(setq whitespace-line-column nil)  ; Use the value of `fill-column'.

;; Can be activated with `display-line-numbers-mode'
(setq-default display-line-numbers-width 3)
(setq-default display-line-numbers-widen t)

(setq truncate-string-ellipsis "…")

;; Disable truncation of printed s-expressions in the message buffer
(setq eval-expression-print-length nil
      eval-expression-print-level nil)

;; Position underlines at the descent line instead of the baseline.
(setq x-underline-at-descent-line t)

(setq remote-file-name-inhibit-cache 50)

;; Automatically rescan the buffer for Imenu entries when `imenu' is invoked
;; This ensures the index reflects recent edits.
(setq imenu-auto-rescan t)

;; Prevent truncation of long function names in `imenu' listings
(setq imenu-max-item-length 160)

;; Disable auto-adding a new line at the bottom when scrolling.
(setq next-line-add-newlines nil)

;; This setting forces Emacs to save bookmarks immediately after each change.
;; Benefit: you never lose bookmarks if Emacs crashes.
(setq bookmark-save-flag 1)

;;; tramp

(setq tramp-verbose 1)
(setq tramp-completion-reread-directory-timeout 50)

;;; Files

;; Delete by moving to trash in interactive mode
(setq delete-by-moving-to-trash (not noninteractive))
(setq remote-file-name-inhibit-delete-by-moving-to-trash t)

;; Ignoring this is acceptable since it will redirect to the buffer regardless.
(setq find-file-suppress-same-file-warnings t)

;; Resolve symlinks so that operations are conducted from the file's directory
(setq find-file-visit-truename t
      vc-follow-symlinks t)

;; Prefer vertical splits over horizontal ones
(setq split-width-threshold 170
      split-height-threshold nil)

;;; Buffers

(setq uniquify-buffer-name-style 'forward)

;;; comint (general command interpreter in a window)

(setq ansi-color-for-comint-mode t
      comint-prompt-read-only t
      comint-buffer-maximum-size 4096)

;;; Compilation

(setq compilation-ask-about-save nil
      compilation-always-kill t
      compilation-scroll-output 'first-error)

;; Skip confirmation prompts when creating a new file or buffer
(setq confirm-nonexistent-file-or-buffer nil)

;;; Backup files

;; Avoid backups or lockfiles to prevent creating world-readable copies of files
(setq create-lockfiles nil)
(setq make-backup-files nil)

(setq backup-directory-alist
      `(("." . ,(expand-file-name "backup" user-emacs-directory))))
(setq tramp-backup-directory-alist backup-directory-alist)
(setq backup-by-copying-when-linked t)
(setq backup-by-copying t)  ; Backup by copying rather renaming
(setq delete-old-versions t)  ; Delete excess backup versions silently
(setq version-control t)  ; Use version numbers for backup files
(setq kept-new-versions 5)
(setq kept-old-versions 5)

;;; VC

(setq vc-git-print-log-follow t)
(setq vc-make-backup-files nil)  ; Do not backup version controlled files
(setq vc-git-diff-switches '("--histogram"))  ; Faster algorithm for diffing.

;;; Auto save

;; Enable auto-save to safeguard against crashes or data loss. The
;; `recover-file' or `recover-session' functions can be used to restore
;; auto-saved data.
(setq auto-save-default nil)
(setq auto-save-no-message t)

;; Do not auto-disable auto-save after deleting large chunks of
;; text.
(setq auto-save-include-big-deletions t)

(setq auto-save-list-file-prefix
      (expand-file-name "autosave/" user-emacs-directory))
(setq tramp-auto-save-directory
      (expand-file-name "tramp-autosave/" user-emacs-directory))

;; Auto save options
(setq kill-buffer-delete-auto-save-files t)

;; Remove duplicates from the kill ring to reduce clutter
(setq kill-do-not-save-duplicates t)

;;; Auto revert
;; Auto-revert in Emacs is a feature that automatically updates the contents of
;; a buffer to reflect changes made to the underlying file.
(setq revert-without-query (list ".")  ; Do not prompt
      auto-revert-stop-on-user-input nil
      auto-revert-verbose t)

;; Revert other buffers (e.g, Dired)
(setq global-auto-revert-non-file-buffers t)
(setq global-auto-revert-ignore-modes '(Buffer-menu-mode))  ; Resolve issue #29

;;; recentf

;; `recentf' is an that maintains a list of recently accessed files.
(setq recentf-max-saved-items 300) ; default is 20
(setq recentf-max-menu-items 15)
(setq recentf-auto-cleanup 'mode)
(setq recentf-exclude nil)

;;; saveplace

;; Enables Emacs to remember the last location within a file upon reopening.
(setq save-place-file (expand-file-name "saveplace" user-emacs-directory))
(setq save-place-limit 600)

;;; savehist

;; `savehist-mode' is an Emacs feature that preserves the minibuffer history
;; between sessions.
(setq history-length 300)
(setq savehist-save-minibuffer-history t)  ;; Default
(setq savehist-additional-variables
      '(kill-ring                        ; clipboard
        register-alist                   ; macros
        mark-ring global-mark-ring       ; marks
        search-ring regexp-search-ring)) ; searches

;;; Frames and windows

;; However, do not resize windows pixelwise, as this can cause crashes in some
;; cases when resizing too many windows at once or rapidly.
(setq window-resize-pixelwise nil)

(setq resize-mini-windows 'grow-only)

;; The native border "uses" a pixel of the fringe on the rightmost
;; splits, whereas `window-divider-mode' does not.
(setq window-divider-default-bottom-width 1
      window-divider-default-places t
      window-divider-default-right-width 1)

;;; Fontification

;; Disable fontification during user input to reduce lag in large buffers.
;; Also helps marginally with scrolling performance.
(setq redisplay-skip-fontification-on-input t)

;;; Scrolling

;; Enables faster scrolling. This may result in brief periods of inaccurate
;; syntax highlighting, which should quickly self-correct.
(setq fast-but-imprecise-scrolling t)

;; Move point to top/bottom of buffer before signaling a scrolling error.
(setq scroll-error-top-bottom t)

;; Keep screen position if scroll command moved it vertically out of the window.
(setq scroll-preserve-screen-position t)

;; Emacs recenters the window when the cursor moves past `scroll-conservatively'
;; lines beyond the window edge. A value over 101 disables recentering; the
;; default (0) is too eager. Here it is set to 20 for a balanced behavior.
(setq scroll-conservatively 20)

;; 1. Preventing automatic adjustments to `window-vscroll' for long lines.
;; 2. Resolving the issue of random half-screen jumps during scrolling.
(setq auto-window-vscroll nil)

;; Number of lines of margin at the top and bottom of a window.
(setq scroll-margin 0)

;; Number of lines of continuity when scrolling by screenfuls.
(setq next-screen-context-lines 0)

;; Horizontal scrolling
(setq hscroll-margin 2
      hscroll-step 1)

;;; Mouse

(setq mouse-yank-at-point nil)

;; Emacs 29
(when (memq 'context-menu minimal-emacs-ui-features)
  (when (and (display-graphic-p) (fboundp 'context-menu-mode))
    (add-hook 'after-init-hook #'context-menu-mode)))

;;; Cursor

;; The blinking cursor is distracting and interferes with cursor settings in
;; some minor modes that try to change it buffer-locally (e.g., Treemacs).
(when (bound-and-true-p blink-cursor-mode)
  (blink-cursor-mode -1))

;; Don't blink the paren matching the one at point, it's too distracting.
(setq blink-matching-paren nil)

;; Do not extend the cursor to fit wide characters
(setq x-stretch-cursor nil)

;; Reduce rendering/line scan work by not rendering cursors or regions in
;; non-focused windows.
(setq-default cursor-in-non-selected-windows nil)
(setq highlight-nonselected-windows nil)

;;; Text editing, indent, font, and formatting

;; Avoid automatic frame resizing when adjusting settings.
(setq global-text-scale-adjust-resizes-frames nil)

;; A longer delay can be annoying as it causes a noticeable pause after each
;; deletion, disrupting the flow of editing.
(setq delete-pair-blink-delay 0.03)

(setq-default left-fringe-width  8)
(setq-default right-fringe-width 8)

;; Disable visual indicators in the fringe for buffer boundaries and empty lines
(setq-default indicate-buffer-boundaries nil)
(setq-default indicate-empty-lines nil)

;; Continue wrapped lines at whitespace rather than breaking in the
;; middle of a word.
(setq-default word-wrap t)

;; Disable wrapping by default due to its performance cost.
(setq-default truncate-lines t)

;; If enabled and `truncate-lines' is disabled, soft wrapping will not occur
;; when the window is narrower than `truncate-partial-width-windows' characters.
(setq truncate-partial-width-windows nil)

;; Configure automatic indentation to be triggered exclusively by newline and
;; DEL (backspace) characters.
(setq-default electric-indent-chars '(?\n ?\^?))

;; Prefer spaces over tabs. Spaces offer a more consistent default compared to
;; 8-space tabs. This setting can be adjusted on a per-mode basis as needed.
(setq-default indent-tabs-mode nil
              tab-width 4)

;; Enable indentation and completion using the TAB key
(setq tab-always-indent 'complete)
(setq tab-first-completion 'word-or-paren-or-punct)

;; Perf: Reduce command completion overhead.
(setq read-extended-command-predicate #'command-completion-default-include-p)

;; Enable multi-line commenting which ensures that `comment-indent-new-line'
;; properly continues comments onto new lines.
(setq comment-multi-line t)

;; Ensures that empty lines within the commented region are also commented out.
;; This prevents unintended visual gaps and maintains a consistent appearance.
(setq comment-empty-lines t)

;; We often split terminals and editor windows or place them side-by-side,
;; making use of the additional horizontal space.
(setq-default fill-column 80)

;; Disable the obsolete practice of end-of-line spacing from the typewriter era.
(setq sentence-end-double-space nil)

;; According to the POSIX, a line is defined as "a sequence of zero or more
;; non-newline characters followed by a terminating newline".
(setq require-final-newline t)

;; Eliminate delay before highlighting search matches
(setq lazy-highlight-initial-delay 0)

;;; Modeline

;; Makes Emacs omit the load average information from the mode line.
(setq display-time-default-load-average nil)

;;; Filetype

;; Do not notify the user each time Python tries to guess the indentation offset
(setq python-indent-guess-indent-offset-verbose nil)

(setq sh-indent-after-continuation 'always)

;;; Dired and ls-lisp

(setq dired-free-space nil
      dired-dwim-target t  ; Propose a target for intelligent moving/copying
      dired-deletion-confirmer 'y-or-n-p
      dired-filter-verbose nil
      dired-recursive-deletes 'top
      dired-recursive-copies 'always
      dired-vc-rename-file t
      dired-create-destination-dirs 'ask
      ;; Suppress Dired buffer kill prompt for deleted dirs
      dired-clean-confirm-killing-deleted-buffers nil)

;; This is a higher-level predicate that wraps `dired-directory-changed-p'
;; with additional logic. This `dired-buffer-stale-p' predicate handles remote
;; files, wdired, unreadable dirs, and delegates to dired-directory-changed-p
;; for modification checks.
(setq auto-revert-remote-files nil)
(setq dired-auto-revert-buffer 'dired-buffer-stale-p)

;; dired-omit-mode
(setq dired-omit-verbose nil
      dired-omit-files (concat "\\`[.]\\'"))

(setq ls-lisp-verbosity nil)
(setq ls-lisp-dirs-first t)

;;; Ediff

;; Configure Ediff to use a single frame and split windows horizontally
(setq ediff-window-setup-function 'ediff-setup-windows-plain
      ediff-split-window-function 'split-window-horizontally)

;;; Help

;; Enhance `apropos' and related functions to perform more extensive searches
(setq apropos-do-all t)

;; Fixes #11: Prevents help command completion from triggering autoload.
;; Loading additional files for completion can slow down help commands and may
;; unintentionally execute initialization code from some libraries.
(setq help-enable-completion-autoload nil)
(setq help-enable-autoload nil)
(setq help-enable-symbol-autoload nil)
(setq help-window-select t)  ;; Focus new help windows when opened

;;; Eglot

;; A setting of nil or 0 means Eglot will not block the UI at all, allowing
;; Emacs to remain fully responsive, although LSP features will only become
;; available once the connection is established in the background.
(setq eglot-sync-connect 0)

(setq eglot-autoshutdown t)  ; Shut down server after killing last managed buffer

;; Activate Eglot in cross-referenced non-project files
(setq eglot-extend-to-xref t)

;; Eglot optimization
(if minimal-emacs-debug
    (setq eglot-events-buffer-config '(:size 2000000 :format full))
  ;; This reduces log clutter to improves performance.
  (setq jsonrpc-event-hook nil)
  ;; Reduce memory usage and avoid cluttering *EGLOT events* buffer
  (setq eglot-events-buffer-size 0)  ; Deprecated
  (setq eglot-events-buffer-config '(:size 0 :format short)))

(setq eglot-report-progress minimal-emacs-debug)  ; Prevent minibuffer spam

;;; Flymake

(setq flymake-show-diagnostics-at-end-of-line nil)

;; Disable wrapping around when navigating Flymake errors.
(setq flymake-wrap-around nil)

;;; hl-line-mode

;; Restrict `hl-line-mode' highlighting to the current window, reducing visual
;; clutter and slightly improving `hl-line-mode' performance.
(setq hl-line-sticky-flag nil)
(setq global-hl-line-sticky-flag nil)

;;; icomplete

;; Do not delay displaying completion candidates in `fido-mode' or
;; `fido-vertical-mode'
(setq icomplete-compute-delay 0.01)

;;; flyspell

(setq flyspell-issue-welcome-flag nil)

;; Improves flyspell performance by preventing messages from being displayed for
;; each word when checking the entire buffer.
(setq flyspell-issue-message-flag nil)

;;; ispell

;; In Emacs 30 and newer, disable Ispell completion to avoid annotation errors
;; when no `ispell' dictionary is set.
(setq text-mode-ispell-word-completion nil)

(setq ispell-silently-savep t)

;;; ibuffer

(setq ibuffer-formats
      '((mark modified read-only locked
              " " (name 55 55 :left :elide)
              " " (size 8 -1 :right)
              " " (mode 18 18 :left :elide) " " filename-and-process)
        (mark " " (name 16 -1) " " filename)))

;;; xref

;; Enable completion in the minibuffer instead of the definitions buffer
(setq xref-show-definitions-function 'xref-show-definitions-completing-read
      xref-show-xrefs-function 'xref-show-definitions-completing-read)

;;; abbrev

;; Ensure `abbrev_defs` is stored in the correct location when
;; `user-emacs-directory` is modified, as it defaults to ~/.emacs.d/abbrev_defs
;; regardless of the change.
(setq abbrev-file-name (expand-file-name "abbrev_defs" user-emacs-directory))

(setq save-abbrevs 'silently)

;;; dabbrev

(setq dabbrev-upcase-means-case-search t)

(setq dabbrev-ignored-buffer-modes
      '(archive-mode image-mode docview-mode tags-table-mode
                     pdf-view-mode tags-table-mode))

(setq dabbrev-ignored-buffer-regexps
      '(;; - Buffers starting with a space (internal or temporary buffers)
        "\\` "
        ;; Tags files such as ETAGS, GTAGS, RTAGS, TAGS, e?tags, and GPATH,
        ;; including versions with numeric extensions like <123>
        "\\(?:\\(?:[EG]?\\|GR\\)TAGS\\|e?tags\\|GPATH\\)\\(<[0-9]+>\\)?"))

;;; Remove warnings from narrow-to-region, upcase-region...

(dolist (cmd '(list-timers narrow-to-region upcase-region downcase-region
                           list-threads erase-buffer scroll-left
                           dired-find-alternate-file set-goal-column))
  (put cmd 'disabled nil))

;;; Load post init
(when (fboundp 'minimal-emacs-load-user-init)
  (minimal-emacs-load-user-init "post-init.el"))
(setq minimal-emacs--success t)

;; Local variables:
;; byte-compile-warnings: (not obsolete free-vars)
;; End:

;;; init.el ends here
#+end_src

* pre-early-init.el
#+begin_src emacs-lisp :tangle "~/.config/emacs/pre-early-init.el"
;;; pre-early-init.el --- DESCRIPTION -*- no-byte-compile: t; lexical-binding: t; -*-
;; (setq minimal-emacs-ui-features '(context-menu tool-bar menu-bar dialogs tooltips))

;;; Reducing clutter in ~/.emacs.d by redirecting files to ~/.emacs.d/var/
;; NOTE: This must be placed in 'pre-early-init.el'.
(setq user-emacs-directory (expand-file-name "var/" minimal-emacs-user-directory))
(setq package-user-dir (expand-file-name "elpa" user-emacs-directory))
#+end_src

* Header
#+begin_src emacs-lisp
;;; post-init.el --- DESCRIPTION -*- no-byte-compile: t; lexical-binding: t; -*-

;;; Commentary:
;; Vanilla Emacs configuration.

;;; Code:

(setq package-archives '(("gnu" . "https://mirrors.ustc.edu.cn/elpa/gnu/")
                         ("nongnu" . "https://mirrors.ustc.edu.cn/elpa/nongnu/")
                         ("melpa" . "https://mirrors.ustc.edu.cn/elpa/melpa/")))

(use-package bind-key)

(use-package diminish
  :config
  (diminish 'eldoc-mode) ;echo area 显示函数的参数列表
  (diminish 'visual-line-mode))

;; libraries
;; (require 'cl-lib)
;; (use-package dash) ;modern list library
;; (use-package s) ;string manipulation library
;; (use-package f) ;file manipulation

;; In Emacs, customization variables modified via the UI (e.g., M-x customize)
;; are typically stored in a separate file, commonly named 'custom.el'. To
;; ensure these settings are loaded during Emacs initialization, it is necessary
;; to explicitly load this file if it exists.
(load custom-file 'noerror 'no-message)

;; disable prompt
;; (dolist (cmd '(narrow-to-page narrow-to-defun))
;;   (put cmd 'disabled nil))
#+end_src

* Systems
** Variables
Use ~getenv~ check the environment variables.

#+begin_src emacs-lisp
(defconst IS-MAC     (eq system-type 'darwin))
(defconst IS-LINUX   (eq system-type 'gnu/linux))
(defconst IS-WINDOWS (memq system-type '(cygwin windows-nt ms-dos)))
(defconst IS-BSD     (or IS-MAC (eq system-type 'berkeley-unix)))
(defconst IS-WSL     (and IS-LINUX
                          (getenv "WSLENV")))
#+end_src

** Linux
#+begin_src emacs-lisp
(when IS-LINUX
  (setq org-directory "~/Documents/org")
  (set-frame-font (font-spec :family "JetBrains Mono" :size 14))
  (when (display-graphic-p)
    (dolist (script '(han cjk-misc bopomofo))
      (set-fontset-font
       (frame-parameter nil 'font)
       script
       (font-spec :name "Noto Sans CJK SC")))))
;; 中英文字体缩放不一致：https://emacs-china.org/t/face-charset-size/16916
#+end_src

** WSL
#+begin_src emacs-lisp
(when IS-WSL
  ;; open links in Windows browser
  ;; https://emacsredux.com/blog/2021/12/19/wsl-specific-emacs-configuration/
  (let ((cmd-exe "/mnt/c/Windows/System32/cmd.exe")
        (cmd-args '("/c" "start")))
    (when (file-exists-p cmd-exe)
      (setq browse-url-generic-program  cmd-exe
            browse-url-generic-args     cmd-args
            browse-url-browser-function 'browse-url-generic
            search-web-default-browser 'browse-url-generic)))
  ;; 解决从 Windows 复制中文到 WSLg 乱码
  (set-clipboard-coding-system 'gbk-dos)
  ;; 解决从 Emacs 复制内容到 Windows 剪贴板
  ;; https://www.lukas-barth.net/blog/emacs-wsl-copy-clipboard/
  (setq select-active-regions nil
        select-enable-clipboard 't
        select-enable-primary nil
        interprogram-cut-function #'gui-select-text))
#+end_src

** Windows
#+begin_src emacs-lisp
(when IS-WINDOWS
  (setq default-directory "C:/Users/zendo/Desktop/" ;主目录
        org-directory "c:/Users/zendo/Documents/org/"
        ;; Optimization
        projectile-git-submodule-command nil
        w32-get-true-file-attributes nil   ; decrease file IO workload
        w32-use-native-image-API t         ; use native w32 API
        w32-pipe-read-delay 0              ; faster IPC
        w32-pipe-buffer-size 65536)        ; read more at a time (64K, was 4K)
  (set-selection-coding-system 'gbk-dos) ; encoding
  (add-to-list 'default-frame-alist '(font . "Maple Mono NF CN-11"))
)
#+end_src

https://lucidmanager.org/productivity/emacs-windows/ Using Emacs on Windows 11: An Installation Guide

** TTY
#+begin_src emacs-lisp
;; Mouse active in tty mode.
(unless (display-graphic-p)
  (xterm-mouse-mode 1))

;; Support for the Kitty Keyboard Protocol in Emacs
(use-package kkp
  :unless (display-graphic-p)
  :config
  ;; (setq kkp-alt-modifier 'alt) ;; use this if you want to map the Alt keyboard modifier to Alt in Emacs (and not to Meta)
  (global-kkp-mode +1))
#+end_src

** Encoding
#+begin_src emacs-lisp
;; Set UTF-8 as the default coding system
(when (fboundp 'set-charset-priority)
  (set-charset-priority 'unicode))
(prefer-coding-system 'utf-8)
(setq locale-coding-system 'utf-8)
#+end_src

** Localization
~C-h f~ =format-time-string= for more details.

#+begin_src emacs-lisp
(setq display-time-24hr-format t)
;; (setq system-time-locale "C") ;使用英文时间格式
;; (setq calendar-latitude 23.38
;;       calendar-longitude 113.20)

(setq world-clock-time-format "  %a %d %b %R %Z")
(setq world-clock-list
      '(
        ("America/Los_Angeles" "旧金山")
        ("America/New_York" "纽约")
        ("Europe/London" "伦敦")
        ("Europe/Paris" "巴黎")
        ("Asia/Calcutta" "班加罗尔")
        ("Asia/Shanghai" "上海")
        ("Asia/Tokyo" "东京")
        ))
#+end_src

** Shell
*** exec-path-from-shell
#+begin_src emacs-lispxxx
(use-package exec-path-from-shell
  :defer t
  :when IS-MAC
  :init
  (exec-path-from-shell-initialize))
#+end_src

*** eshell
#+begin_src emacs-lisp
#+end_src

*** eat
#+begin_src emacs-lisp
;; (use-package eat
;;   :defer t
;;   :hook
;;   ;; For `eat-eshell-mode' -- integration with eshell.
;;   (eshell-mode-hook . eat-eshell-mode)
;;   :config
;;   (setq eat-kill-buffer-on-exit t
;;         eat-enable-yank-to-terminal t
;;         eat-enable-directory-tracking t
;;         eat-enable-shell-command-history t
;;         eat-enable-shell-prompt-annotation t
;;         eat-term-scrollback-size nil))

(use-package eat
  :defer t
  :custom
  (eat-term-name "xterm")
  :config
  (eat-eshell-mode)                     ; use Eat to handle term codes in program output
  (eat-eshell-visual-command-mode))     ; commands like less will be handled by Eat
#+end_src

*** vterm
#+begin_src emacs-lisp
(use-package vterm
  :defer t
  :when (eq system-type 'gnu/linux)
  :config
  (setq vterm-shell "zsh")
  :bind (:map vterm-mode-map
              ;; default: ("C-c C-t" . vterm-copy-mode)
              ("<f2>" . shell-pop)))
#+end_src

*** shell-pop
#+begin_src emacs-lisp
(use-package shell-pop
  :bind (("<f2>" . shell-pop))
  :init
  (setq shell-pop-window-size 30
        shell-pop-shell-type
        (cond ((eq system-type 'gnu/linux) '("vterm" "*vterm*" #'vterm))
              (IS-WINDOWS '("eshell" "*eshell*" #'eshell))
              (t '("terminal" "*terminal*"
                   (lambda () (term shell-pop-term-shell)))))))
#+end_src

** Tramp
https://coredumped.dev/2025/06/18/making-tramp-go-brrrr./

#+begin_src emacs-lisp
(setq tramp-default-method "ssh"
      password-cache-expiry 36000)
#+end_src

** Server Client
https://www.gnu.org/software/emacs/manual/html_node/emacs/emacsclient-Options.html

#+BEGIN_SRC emacs-lisp
(use-package server
  :ensure nil
  :if window-system
  :defer 2
  :config
  ;; remove client startup messages
  (setq server-client-instructions nil)
  (unless (server-running-p)
    (server-start)))

;; fix recentf not load
(add-hook 'delete-terminal-functions (lambda (terminal) (recentf-save-list)))
#+END_SRC

** ispell、flyspell
#+begin_src emacs-lispxx
;; The flyspell package is a built-in Emacs minor mode that provides
;; on-the-fly spell checking. It highlights misspelled words as you type,
;; offering interactive corrections. In text modes, it checks the entire buffer,
;; while in programming modes, it typically checks only comments and strings. It
;; integrates with external spell checkers like aspell, hunspell, or
;; ispell to provide suggestions and corrections.
;;
;; NOTE: flyspell-mode can become slow when using Aspell, especially with large
;; buffers or aggressive suggestion settings like --sug-mode=ultra. This
;; slowdown occurs because Flyspell checks words dynamically as you type or
;; navigate text, requiring frequent communication between Emacs and the
;; external Aspell process. Each check involves sending words to Aspell and
;; receiving results, which introduces overhead from process invocation and
;; inter-process communication.
(use-package ispell
  :ensure nil
  :commands (ispell ispell-minor-mode)
  :custom
  ;; Set the ispell program name to aspell
  ;; aspell or hunspell
  (ispell-program-name "hunspell")

  ;; Define the "en_US" spell-check dictionary locally, telling Emacs to use
  ;; UTF-8 encoding, match words using alphabetic characters, allow apostrophes
  ;; inside words, treat non-alphabetic characters as word boundaries, and pass
  ;; -d en_US to the underlying spell-check program.
  (ispell-local-dictionary-alist
   '(("en_US" "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "en_US") nil utf-8)))

  ;; Configures Aspell's suggestion mode to "ultra", which provides more
  ;; aggressive and detailed suggestions for misspelled words. The language
  ;; is set to "en_US" for US English, which can be replaced with your desired
  ;; language code (e.g., "en_GB" for British English, "de_DE" for German).
  (ispell-extra-args '(; "--sug-mode=ultra"
                       "--lang=en_US")))

;; The flyspell package is a built-in Emacs minor mode that provides
;; on-the-fly spell checking. It highlights misspelled words as you type,
;; offering interactive corrections.
(use-package flyspell
  :ensure nil
  :commands flyspell-mode
  :hook
  (; (prog-mode . flyspell-prog-mode)
   (text-mode . (lambda()
                  (if (or (derived-mode-p 'yaml-mode)
                          (derived-mode-p 'yaml-ts-mode)
                          (derived-mode-p 'ansible-mode))
                      (flyspell-prog-mode 1)
                    (flyspell-mode 1)))))
  :config
  ;; Remove strings from Flyspell
  (setq flyspell-prog-text-faces (delq 'font-lock-string-face
                                       flyspell-prog-text-faces))

  ;; Remove doc from Flyspell
  (setq flyspell-prog-text-faces (delq 'font-lock-doc-face
                                       flyspell-prog-text-faces)))
#+end_src

* Interface
#+begin_src emacs-lisp
(setq initial-frame-alist (quote ((fullscreen . maximized))))
(setq-default frame-title-format "%b (%f)") ;标题栏显示正在编辑的文件名
#+end_src

** Themes
#+begin_src emacs-lisp
(mapc #'disable-theme custom-enabled-themes)  ; Disable all active minimal-emacs.d themes
(use-package doom-themes
  :hook
  ;; doom-badger
  (after-init
   . (lambda ()
       (load-theme 'doom-tomorrow-night t)))
  )

;; (use-package doric-themes)

;; (use-package eclipse-theme
;;   :config
;;   (load-theme 'eclipse t))

;; (use-package ef-theme
;;   :config
;;   (load-theme 'ef-frost t))
#+end_src

** Icons
#+begin_src emacs-lisp
(use-package nerd-icons)

(use-package nerd-icons-dired
  :hook
  (dired-mode . nerd-icons-dired-mode))

(use-package nerd-icons-completion
  :after marginalia
  :config
  (add-hook 'marginalia-mode-hook #'nerd-icons-completion-marginalia-setup))

;; (use-package nerd-icons-corfu
;;   :after corfu
;;   :config
;;   (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))

;; (use-package kind-icon
;;   :if (display-graphic-p)
;;   :after corfu
;;   :config
;;   (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))
#+end_src

** emoji
Managed by Nix.

#+begin_src emacs-lisp
(use-package emojify
  :defer t
  :when IS-WINDOWS
  :hook (after-init . global-emojify-mode))
#+end_src

** Mode-line
#+begin_src emacs-lisp
;; Handle by mood-modeline
;; (column-number-mode t) ;显示列数
;; (size-indication-mode t) ;显示文件大小
;; (display-time-mode t) ;显示时间
;; (unless (string-match-p "^Power N/A" (battery))
;;   (display-battery-mode 1))

(use-package doom-modeline
  :disabled
  :hook
  (after-init . doom-modeline-mode)
  :custom ((doom-modeline-buffer-file-name-style 'relative-to-project)
           (doom-modeline-icon nil)
           (line-number-mode 1)
           (column-number-mode 1)))

(use-package mood-line
  ;; :disabled
  :hook
  ;; load it earilier to have a smooth startup
  (after-init . mood-line-mode))

;; Scrollbar on mode line
(use-package mlscroll
  :disabled
  :config
  (setq mlscroll-shortfun-min-width 11) ; truncate which-func
  (mlscroll-mode 1))

(use-package nyan-mode
  :commands nyan-mode)
#+end_src

** Tab-bar
#+begin_src emacs-lisp
(use-package centaur-tabs
  :custom ((centaur-tabs-height 28)
           (centaur-tabs-style "wave")
           (centaur-tabs-set-icons t)
           (centaur-tabs-icon-type 'nerd-icons)
           (centaur-tabs-set-bar 'over)
           (centaur-tabs-set-close-button nil)
           (centaur-tabs-set-modified-marker t)
           (centaur-tabs-modified-marker "●"))
  :hook
  (dashboard-mode . centaur-tabs-local-mode) ;; Disable centaur-tabs in selected buffers
  :config
  (centaur-tabs-mode t))
#+end_src

** Dashboard
#+begin_src emacs-lisp
(use-package dashboard
  :when (display-graphic-p)
;; :diminish (dashboard-mode page-break-lines-mode)
  :custom
  (dashboard-startup-banner 2)
  (dashboard-set-heading-icons t)
  (dashboard-set-file-icons t)
  (dashboard-set-footer nil)
  (dashboard-center-content t)
  (dashboard-icon-type 'nerd-icons)
  (dashboard-projects-backend 'project-el)
  (dashboard-banner-logo-title nil) ; "Welcome to Emacs!"
  (dashboard-items  '((recents  . 12)
                      (bookmarks . 5)
                      (projects . 5)))
  :config
  (dashboard-setup-startup-hook))
;; Fix for emacsclient 启动打开 dashboard 而不是 scratch
;; bug: 会导致 magit comit save 后跳到 dashboard
;; (add-hook 'server-after-make-frame-hook (lambda () (dashboard-refresh-buffer)))
#+end_src

** Treemacs
#+begin_src emacs-lisp
(use-package treemacs
  :bind (("<f1>" . +treemacs/toggle)
         (:map treemacs-mode-map
               ("<mouse-1>" . treemacs-single-click-expand-action)))
  :config
  (setq treemacs-follow-after-init t
        treemacs-project-follow-mode t
        treemacs-git-commit-diff-mode t
        treemacs-file-follow-delay 2
        treemacs-collapse-dirs 0
        treemacs-show-cursor nil
        treemacs-silent-filewatch t
        treemacs-silent-refresh t))

;; https://github.com/doomemacs/doomemacs/blob/master/modules/ui/treemacs/autoload.el
;;;###autoload
(defun +treemacs/toggle ()
  "Initialize or toggle treemacs.

Ensures that only the current project is present and all other projects have
been removed.

Use `treemacs' command for old functionality."
  (interactive)
  (require 'treemacs)
  (pcase (treemacs-current-visibility)
    (`visible (delete-window (treemacs-get-local-window)))
    (_ (let ((project (treemacs--find-current-user-project)))
         (if (and project (not (file-equal-p project "~")))
             (treemacs-add-and-display-current-project-exclusively)
           (message "No valid project in current buffer; opening last treemacs session")
           (treemacs))))))
#+end_src

** perfect-margin
#+begin_src emacs-lisp
(use-package perfect-margin
  ;; :custom
  ;; (perfect-margin-visible-width 128)
  :config
  (perfect-margin-mode t)
  (setq perfect-margin-ignore-filters nil) ;; auto-center minibuffer windows
  (setq perfect-margin-ignore-regexps nil) ;; auto-center special windows
)
#+end_src

** spatial-padding
#+begin_src emacs-lisp
(use-package spacious-padding
  :config
  (spacious-padding-mode +1))
#+end_src

** indent-bars
#+begin_src emacs-lisp
(use-package indent-bars
  :defer t)
#+end_src

** hl-todo
#+begin_src emacs-lisp
(use-package hl-todo
  :config
  (global-hl-todo-mode))
#+end_src

** rainbow
#+begin_src emacs-lisp
;; rainbow 颜色代码显色 #00FF00
(use-package rainbow-mode
  :commands rainbow-mode)

;; rainbow-delimiters 彩虹括号
(use-package rainbow-delimiters
  :hook (prog-mode . rainbow-delimiters-mode))
#+end_src

** colorful-mode
#+begin_src emacs-lisp
(use-package colorful-mode
  ;; :diminish
  ;; :ensure t ; Optional
  :custom
  (colorful-use-prefix t)
  (colorful-only-strings 'only-prog)
  (css-fontify-colors nil)
  :config
  (global-colorful-mode t)
  (add-to-list 'global-colorful-modes 'helpful-mode))
#+end_src

** scrollkeeper
like ~beacon~

#+begin_src emacs-lisp
(use-package scrollkeeper
  :bind
  (([remap scroll-up-command] . scrollkeeper-contents-up)
   ([remap scroll-down-command] . scrollkeeper-contents-down)))
#+end_src

** breadcrumb
Display the structure path below the tab bar.
like ~otree~

#+begin_src emacs-lisp
(use-package breadcrumb
  :commands breadcrumb-mode)
#+end_src

** idle-highlight-mode :disable:
#+begin_src emacs-lispxx
(use-package idle-highlight-mode
  :hook ((prog-mode text-mode) . idle-highlight-mode)
  :config
  (setq idle-highlight-idle-time 0.2
        ;; highlight subwords too
        idle-highlight-exceptions-syntax nil))
#+end_src

** writeroom-mode
#+begin_src emacs-lisp
(use-package writeroom-mode
  :commands writeroom-mode)
#+end_src

* Buffer
** uniquify
#+begin_src emacs-lisp
(use-package uniquify
  :ensure nil
  :custom
  (uniquify-buffer-name-style 'reverse)
  (uniquify-separator "•")
  (uniquify-after-kill-buffer-p t))
#+end_src

** ibuffer
#+begin_src emacs-lisp
(defalias 'list-buffers 'ibuffer)
(setq ibuffer-expert t) ; 直接操作不询问
(setq ibuffer-use-other-window t)
#+end_src

** buffer-terminator
#+begin_src emacs-lisp
(use-package buffer-terminator
  :ensure t
  :custom
  ;; Enable/Disable verbose mode to log buffer cleanup events
  (buffer-terminator-verbose nil)

  ;; Set the inactivity timeout (in seconds) after which buffers are considered
  ;; inactive (default is 30 minutes):
  (buffer-terminator-inactivity-timeout (* 30 60)) ; 30 minutes

  ;; Define how frequently the cleanup process should run (default is every 10
  ;; minutes):
  (buffer-terminator-interval (* 10 60)) ; 10 minutes

  :config
  (buffer-terminator-mode 1))
#+end_src

* Window
#+begin_src emacs-lisp
;; prefer vertical splits by default
(setq split-width-threshold 120)

;; winner C-c ←/→ for window undo/redo
(winner-mode 1)
#+end_src

** ace-window
#+begin_src emacs-lisp
(use-package ace-window
  :bind ([remap other-window] . ace-window))
#+end_src

** rotate
#+begin_src emacs-lisp
(use-package rotate
  :defer t)
#+end_src

** golden-ratio
#+begin_src emacs-lispxx
(use-package golden-ratio
  :config (golden-ratio-mode 1))
#+end_src

** persp-mode
#+begin_src emacs-lispxx
(use-package persp-mode
  :init (setq persp-keymap-prefix (kbd "C-c w w"))
  :config
  ;; (setq wg-morph-on nil) ;; switch off animation
  (setq persp-auto-resume-time 0)
  (add-hook 'after-init-hook #'(lambda () (persp-mode 1))))
#+end_src

** easysession-mode
#+begin_src emacs-lisp
;; The easysession Emacs package is a session manager for Emacs that can persist
;; and restore file editing buffers, indirect buffers/clones, Dired buffers,
;; windows/splits, the built-in tab-bar (including tabs, their buffers, and
;; windows), and Emacs frames. It offers a convenient and effortless way to
;; manage Emacs editing sessions and utilizes built-in Emacs functions to
;; persist and restore frames.
(use-package easysession
  :commands (easysession-switch-to
             easysession-save-as
             easysession-save-mode
             easysession-load-including-geometry)

  :custom
  (easysession-mode-line-misc-info t)  ; Display the session in the modeline
  (easysession-save-interval (* 10 60))  ; Save every 10 minutes

  :init
  ;; The depth 102 and 103 have been added to to `add-hook' to ensure that the
  ;; session is loaded after all other packages. (Using 103/102 is particularly
  ;; useful for those using minimal-emacs.d, where some optimizations restore
  ;; `file-name-handler-alist` at depth 101 during `emacs-startup-hook`.)
  ;; (add-hook 'emacs-startup-hook #'easysession-load-including-geometry 102)
  (add-hook 'emacs-startup-hook #'easysession-save-mode 103))
#+end_src

** stillness-mode
弹出 minibuffer 时候保持 window 稳定
https://github.com/neeasade/stillness-mode.el
#+begin_src emacs-lisp
(use-package stillness-mode
  :config
  (stillness-mode +1))
#+end_src

* Editor
** basic
#+begin_src emacs-lisp
(show-paren-mode t) ;括号匹配 parens
(electric-pair-mode t) ;自动补全括号

;; 滚动时保持显示稳定
(setq display-line-numbers-width-start nil)
(setq display-line-numbers-grow-only t)

;; save system clipboard before emacs clipboard
(setq save-interprogram-paste-before-kill t)
;; overwrite selected text
(delete-selection-mode t)

(global-prettify-symbols-mode 1) ;Show lambda as λ.
;; 识别中文标点符号
(setq sentence-end "\\([。！？]\\|……\\|[.?!][]\"')}]*\\($\\|[ \t]\\)\\)[ \t\n]*")

;;Don't hang when visiting files with extremely long lines
(global-so-long-mode t)
#+end_src

** word-wrap
#+begin_src emacs-lisp
;; (global-visual-line-mode 1) ;视觉换行
;; Better word wrapping for CJK characters
;; (setq word-wrap-by-category t)
;; (set-default 'word-wrap nil) ;在任意字符处拆分单词换行
;; (set-default 'truncate-lines nil) ;启用行截断，可能影响性能

;; ~display-fill-column-indicator-mode~
;; (setq-default fill-column 80) ; default: 70 init: 80
#+end_src
** outline
#+begin_src emacs-lispxx
;; The built-in outline-minor-mode provides structured code folding in modes
;; such as Emacs Lisp and Python, allowing users to collapse and expand sections
;; based on headings or indentation levels. This feature enhances navigation and
;; improves the management of large files with hierarchical structures.
(use-package outline
  :ensure nil
  :commands outline-minor-mode
  :hook
  ((emacs-lisp-mode . outline-minor-mode)
   ;; Use " ▼" instead of the default ellipsis "..." for folded text to make
   ;; folds more visually distinctive and readable.
   (outline-minor-mode
    .
    (lambda()
      (let* ((display-table (or buffer-display-table (make-display-table)))
             (face-offset (* (face-id 'shadow) (ash 1 22)))
             (value (vconcat (mapcar (lambda (c) (+ face-offset c)) " ▼"))))
        (set-display-table-slot display-table 'selective-display value)
        (setq buffer-display-table display-table))))))

;; The outline-indent Emacs package provides a minor mode that enables code
;; folding based on indentation levels.
;;
;; In addition to code folding, *outline-indent* allows:
;; - Moving indented blocks up and down
;; - Indenting/unindenting to adjust indentation levels
;; - Inserting a new line with the same indentation level as the current line
;; - Move backward/forward to the indentation level of the current line
;; - and other features.
(use-package outline-indent
  :ensure t
  :commands outline-indent-minor-mode

  :custom
  (outline-indent-ellipsis " ▼")

  :init
  ;; The minor mode can also be automatically activated for a certain modes.
  (add-hook 'python-mode-hook #'outline-indent-minor-mode)
  (add-hook 'python-ts-mode-hook #'outline-indent-minor-mode)

  (add-hook 'yaml-mode-hook #'outline-indent-minor-mode)
  (add-hook 'yaml-ts-mode-hook #'outline-indent-minor-mode)

  (add-hook 'nix-mode-hook #'outline-indent-minor-mode)
  (add-hook 'nix-ts-mode-hook #'outline-indent-minor-mode)
  )
#+end_src
** hideshow
#+begin_src emacs-lisp
(use-package hideshow
  :hook
  (prog-mode . hs-minor-mode))
#+end_src

** puni
soft kill line.
https://github.com/AmaiKinono/puni

#+begin_src emacs-lisp
(use-package puni
  :disabled
  :config
  (puni-global-mode +1))
#+end_src

** whitespace
#+begin_src emacs-lisp
(setq whitespace-action '(auto-cleanup)  ;automatically clean up bad whitespace
      whitespace-style '(face
                         trailing space-before-tab
                         indentation empty space-after-tab))
(whitespace-mode 1)
#+end_src

** stripspace
#+begin_src emacs-lispxx
;; The stripspace Emacs package provides stripspace-local-mode, a minor mode
;; that automatically removes trailing whitespace and blank lines at the end of
;; the buffer when saving.
(use-package stripspace
  :commands stripspace-local-mode

  ;; Enable for prog-mode-hook, text-mode-hook, conf-mode-hook
  :hook ((prog-mode . stripspace-local-mode)
         (text-mode . stripspace-local-mode)
         (conf-mode . stripspace-local-mode))

  :custom
  ;; The `stripspace-only-if-initially-clean' option:
  ;; - nil to always delete trailing whitespace.
  ;; - Non-nil to only delete whitespace when the buffer is clean initially.
  ;; (The initial cleanliness check is performed when `stripspace-local-mode'
  ;; is enabled.)
  (stripspace-only-if-initially-clean nil)

  ;; Enabling `stripspace-restore-column' preserves the cursor's column position
  ;; even after stripping spaces. This is useful in scenarios where you add
  ;; extra spaces and then save the file. Although the spaces are removed in the
  ;; saved file, the cursor remains in the same position, ensuring a consistent
  ;; editing experience without affecting cursor placement.
  (stripspace-restore-column t))
#+end_src

** mixed-pitch
https://gitlab.com/jabranham/mixed-pitch

#+begin_src emacs-lispxx
(use-package mixed-pitch
  :config
  (setq-default mixed-pitch-set-height t))
#+end_src

* Dired
** dired enhanced
#+begin_src emacs-lisp
(use-package diredfl
  :config
  (diredfl-global-mode 1))

(use-package dired-git-info
  :config (setq dgi-auto-hide-details-p nil)
  :hook (dired-after-readin . dired-git-info-auto-enable))

(use-package dired-x
  :ensure nil)

(use-package dired
  :ensure nil
  :custom ((dired-listing-switches "-lha --group-directories-first"))
  :bind (("s-d" . dired-jump)
         ("C-x C-d" . dired-jump)
         :map dired-mode-map
         ("f" . consult-find)
         ("RET" . dired-find-alternate-file)
         ("." . dired-omit-mode)
         ("," . dired-do-print)
         ("/" . funs/dired-filter-show-match)
         ("b" . (lambda ()
                  (interactive)
                  (find-alternate-file ".."))))
  :config
  ;;;###autoload
  (defun funs/dired-filter-show-match ()
    "Only show filter file."
    (interactive)
    (call-interactively #'dired-mark-files-regexp)
    (command-execute "tk")))
#+end_src

** dirvish
#+begin_src emacs-lispxx
(use-package dirvish
  :hook (after-init . dirvish-override-dired-mode)
  :bind (:map dired-mode-map
              ("TAB" . dirvish-toggle-subtree)
              ("SPC" . dirvish-show-history)
              ("*"   . dirvish-mark-menu)
              ("r"   . dirvish-roam)
              ("b"   . dirvish-goto-bookmark)
              ("f"   . dirvish-file-info-menu)
              ("M-n" . dirvish-go-forward-history)
              ("M-p" . dirvish-go-backward-history)
              ("M-s" . dirvish-setup-menu)
              ("M-f" . dirvish-toggle-fullscreen)
              ([left] . dired-up-directory)
              ([right] . dired-find-file)
              ([remap dired-sort-toggle-or-edit] . dirvish-quicksort)
              ([remap dired-do-redisplay] . dirvish-ls-switches-menu)
              ([remap dired-summary] . dirvish-dispatch)
              ([remap dired-do-copy] . dirvish-yank-menu)
              ([remap mode-line-other-buffer] . dirvish-other-buffer))
  :config
  ; (dirvish-peek-mode) ;; file-preview cost a lot time
  (setq dirvish-hide-details t)
  )
#+end_src

** disk-usage
#+begin_src emacs-lisp
(use-package disk-usage
  :commands disk-usage)
#+end_src

* Backup
** auto-save
#+begin_src emacs-lisp
;; Enable `auto-save-mode' to prevent data loss. Use `recover-file' or
;; `recover-session' to restore unsaved changes.
(setq auto-save-interval 300)
(setq auto-save-timeout 30)

;; When auto-save-visited-mode is enabled, Emacs will auto-save file-visiting
;; buffers after a certain amount of idle time if the user forgets to save it
;; with save-buffer or C-x s for example.
;;
;; This is different from auto-save-mode: auto-save-mode periodically saves
;; all modified buffers, creating backup files, including those not associated
;; with a file, while auto-save-visited-mode only saves file-visiting buffers
;; after a period of idle time, directly saving to the file itself without
;; creating backup files.
;; OR `super-save`
;; (setq auto-save-visited-interval 5) ; Save after 5 seconds if inactivity
;; (auto-save-visited-mode 1)
;; (add-function :after after-focus-change-function (lambda () (save-some-buffers t))) ; 失去焦点便自动保存
#+end_src

** super-save
#+begin_src emacs-lisp
(use-package super-save
  :hook (after-init . super-save-mode)
  :config
  ;; Emacs空闲是否自动保存，这里不设置
  (setq super-save-auto-save-when-idle nil)
  ;; 切换窗口自动保存
  (add-to-list 'super-save-triggers 'other-window)
  ;; 查找文件时自动保存
  (add-to-list 'super-save-hook-triggers 'find-file-hook)
  ;; 远程文件编辑不自动保存
  (setq super-save-remote-files nil)
  ;; 特定后缀名的文件不自动保存
  (setq super-save-exclude '(".gpg"))
  ;; 自动保存时，保存所有缓冲区
  (defun super-save/save-all-buffers ()
    (save-excursion
      (dolist (buf (buffer-list))
        (set-buffer buf)
        (when (and buffer-file-name
                   (buffer-modified-p (current-buffer))
                   (file-writable-p buffer-file-name)
                   (if (file-remote-p buffer-file-name) super-save-remote-files t))
          (save-buffer)))))
  (advice-add 'super-save-command :override 'super-save/save-all-buffers)
  )
#+end_src

** recentf、savehist、saveplace、auto-revert
#+begin_src emacs-lisp
;; Auto-revert in Emacs is a feature that automatically updates the
;; contents of a buffer to reflect changes made to the underlying file
;; on disk.
(use-package autorevert
  :ensure nil
  :commands (auto-revert-mode global-auto-revert-mode)
  :hook
  (after-init . global-auto-revert-mode)
  :custom
  (auto-revert-interval 3)
  (auto-revert-remote-files nil)
  (auto-revert-use-notify t)
  (auto-revert-avoid-polling nil)
  (auto-revert-verbose t))

;; Recentf is an Emacs package that maintains a list of recently
;; accessed files, making it easier to reopen files you have worked on
;; recently.
(use-package recentf
  :ensure nil
  :commands (recentf-mode recentf-cleanup)
  :hook
  (after-init . recentf-mode)

  :custom
  (recentf-auto-cleanup (if (daemonp) 300 'never))
  (recentf-exclude
   (list "\\.tar$" "\\.tbz2$" "\\.tbz$" "\\.tgz$" "\\.bz2$"
         "\\.bz$" "\\.gz$" "\\.gzip$" "\\.xz$" "\\.zip$"
         "\\.7z$" "\\.rar$"
         "COMMIT_EDITMSG\\'" "persp-auto-save" "\\.cache"
         "~/.config/emacs"
         "\\.\\(?:gz\\|gif\\|svg\\|png\\|jpe?g\\|bmp\\|xpm\\)$"
         "-autoloads\\.el$" "autoload\\.el$"))

  :config
  ;; A cleanup depth of -90 ensures that `recentf-cleanup' runs before
  ;; `recentf-save-list', allowing stale entries to be removed before the list
  ;; is saved by `recentf-save-list', which is automatically added to
  ;; `kill-emacs-hook' by `recentf-mode'.
  (add-hook 'kill-emacs-hook #'recentf-cleanup -90))

;; savehist is an Emacs feature that preserves the minibuffer history between
;; sessions. It saves the history of inputs in the minibuffer, such as commands,
;; search strings, and other prompts, to a file. This allows users to retain
;; their minibuffer history across Emacs restarts.
(use-package savehist
  :ensure nil
  :commands (savehist-mode savehist-save)
  :hook
  (after-init . savehist-mode)
  :custom
  (savehist-autosave-interval 600)
  (savehist-additional-variables
   '(kill-ring                        ; clipboard
     register-alist                   ; macros
     mark-ring global-mark-ring       ; marks
     search-ring regexp-search-ring)))

;; save-place-mode enables Emacs to remember the last location within a file
;; upon reopening. This feature is particularly beneficial for resuming work at
;; the precise point where you previously left off.
(use-package saveplace
  :ensure nil
  :commands (save-place-mode save-place-local-mode)
  :hook
  (after-init . save-place-mode)
  :custom
  (save-place-limit 400))
#+end_src

** bookmark
#+begin_src emacs-lisp
(use-package bm
  :defer t)
#+end_src

** undo-fu
#+begin_src emacs-lisp
;; The undo-fu package is a lightweight wrapper around Emacs' built-in undo
;; system, providing more convenient undo/redo functionality.
(use-package undo-fu
  :ensure t
  :commands (undo-fu-only-undo
             undo-fu-only-redo
             undo-fu-only-redo-all
             undo-fu-disable-checkpoint))

;; The undo-fu-session package complements undo-fu by enabling the saving
;; and restoration of undo history across Emacs sessions, even after restarting.
(use-package undo-fu-session
  :ensure t
  :commands undo-fu-session-global-mode
  :hook (after-init . undo-fu-session-global-mode))
#+end_src

** vundo
#+begin_src emacs-lisp
(use-package vundo
  :bind (("C-x u" . vundo))
  :config
  (setq vundo-glyph-alist vundo-unicode-symbols)
  (setq vundo-roll-back-on-quit nil))
#+end_src

* Packages
** helpful
#+begin_src emacs-lisp
;; Helpful is an alternative to the built-in Emacs help that provides much more
;; contextual information.
(use-package helpful
  :commands (helpful-callable
             helpful-variable
             helpful-key
             helpful-command
             helpful-at-point
             helpful-function)
  :bind
  ([remap describe-command] . helpful-command)
  ([remap describe-function] . helpful-callable)
  ([remap describe-key] . helpful-key)
  ([remap describe-symbol] . helpful-symbol)
  ([remap describe-variable] . helpful-variable)
  :custom
  (helpful-max-buffers 7))
#+end_src

** avy
#+begin_src emacs-lisp
(use-package avy
  :defer t)
#+end_src

** avy-zap
#+begin_src emacs-lisp
(use-package avy-zap
  :bind ("M-z" . avy-zap-up-to-char-dwim))
#+end_src

** ialign
#+begin_src emacs-lisp
(use-package ialign
  :commands ialign)
#+end_src

** mwim
moving to the beginning/end code

#+begin_src emacs-lisp
(use-package mwim
  :bind (("C-a" . mwim-beginning-of-code-or-line)
         ("C-e" . mwim-end-of-code-or-line)))

;; (use-package mosey
;;   :bind (("C-a" . mosey-backward-bounce)
;;          ("C-e" . mosey-forward-bounce)))
#+end_src

** iedit
#+begin_src emacs-lisp
(use-package iedit
  :defer t)
#+end_src

** wgrep
#+begin_src emacs-lisp
;; Writable grep buffer
(use-package wgrep
  :defer t)
#+end_src

** move-text
#+begin_src emacs-lisp
;; move-text M-up/M-down
(use-package move-text
  :init
  (move-text-default-bindings))
#+end_src

** easy-kill
#+begin_src emacs-lisp
(use-package easy-kill
  :bind (([remap mark-sexp] . easy-mark)
         ([remap kill-ring-save] . easy-kill)))
#+end_src

** multiple-cursors
#+begin_src emacs-lisp
(use-package multiple-cursors
  :bind (("C-<f2>" . mc/mark-all-words-like-this)
         ("M-<mouse-1>" .  mc/toggle-cursor-on-click)
         ("C-}" . mc/mark-next-like-this)
         ("C-{" . mc/mark-previous-like-this)
         ("C-|" . mc/mark-all-like-this-dwim)
         ;; ("s-<mouse-1>" . mc/add-cursor-on-click)
         ))
#+end_src

** expreg
expand region alternative 

#+begin_src emacs-lisp
(use-package expreg
  :bind (("C-=" . expreg-expand)
         ("C--" . expreg-contract)))
#+end_src

** crux
#+begin_src emacs-lisp
(use-package crux
  :bind
  ([remap kill-line] . crux-smart-kill-line)
  ([remap open-line] . crux-smart-open-line)
  ("C-<return>" . crux-smart-open-line)
  ("C-S-<return>" . crux-smart-open-line-above))
#+end_src

** deadgrep
#+begin_src emacs-lisp
(use-package deadgrep
  :bind ("C-c C-s" . deadgrep))
#+end_src

** isl :disable:
https://github.com/thierryvolpiatto/isearch-light

#+begin_src emacs-lispxx
(use-package isl
  :bind
  ("C-s" . isl-search)
  ;; ([remap isearch-forward] . )
  ;; ([remap isearch-backward] . )
  ;; ([remap isearch-forward-regexp] . )
  ;; ([remap isearch-forward-regexp] .)
  )
#+end_src

** anzu
#+begin_src emacs-lispxx
(use-package anzu
  :bind
  ([remap query-replace] . anzu-query-replace)
  ([remap query-replace-regexp] . anzu-query-replace-regexp))
#+end_src

** visual-replace
#+begin_src emacs-lisp
(use-package visual-replace
  :bind (([remap query-replace] . visual-replace)
         ;; ("C-c r" . visual-replace)
         :map isearch-mode-map
         ("C-c r" . visual-replace-from-isearch)))
#+end_src

** goto-last-change
#+begin_src emacs-lisp
(use-package goto-last-change
  :bind ("M-g l" . goto-last-change))
#+end_src

** fanyi
#+begin_src emacs-lisp
(use-package fanyi
  :bind ("C-c y" . fanyi-dwim2)
  :custom
  (fanyi-providers '(fanyi-haici-provider ;; 海词
                     fanyi-youdao-thesaurus-provider ;; 有道同义词词典
                     ;; fanyi-etymon-provider ;; Etymonline
                     ;; fanyi-longman-provider ;; Longman
                     )))
#+end_src

** maple-translate :disable:
#+begin_src emacs-lispxx
(use-package maple-translate
  :vc (:url "https://github.com/honmaple/emacs-maple-translate"
            :rev :newest)
  :commands (maple-translate maple-translate+))
#+end_src

** pass
#+begin_src emacs-lisp :tangle no
(use-package pass
  :commands pass)
#+end_src

** vlf
#+begin_src emacs-lisp
;; View Large Files
(use-package vlf
  :defer t)
#+end_src

** nov
#+begin_src emacs-lisp :tangle no
(use-package nov
  :mode ("\\.epub\\'" . nov-mode)
  :bind (:map nov-mode-map
              ("j" . scroll-up-line)
              ("k" . scroll-down-line))
  )
#+end_src

** qrencode
#+begin_src emacs-lisp
(use-package qrencode
  :defer t)
#+end_src

** esup
#+begin_src emacs-lisp
(use-package esup
  :defer t
  :init
  ;; https://github.com/progfolio/elpaca/issues/23
  (setq esup-depth 0))
#+end_src

* Completions
** Corfu、Cape
#+begin_src emacs-lisp
;; Corfu enhances in-buffer completion by displaying a compact popup with
;; current candidates, positioned either below or above the point. Candidates
;; can be selected by navigating up or down.
(use-package corfu
  :commands (corfu-mode global-corfu-mode)

  :hook ((prog-mode . corfu-mode)
         (shell-mode . corfu-mode)
         (eshell-mode . corfu-mode))

  :custom
  ;; Hide commands in M-x which do not apply to the current mode.
  (read-extended-command-predicate #'command-completion-default-include-p)
  ;; Disable Ispell completion function. As an alternative try `cape-dict'.
  (text-mode-ispell-word-completion nil)
  (tab-always-indent 'complete)
  (corfu-auto t) ; Enable auto completion
  (corfu-cycle t) ; Allows cycling through candidates
  (corfu-min-width 25)
  (corfu-preview-current nil) ; Disable previewing the current candidate

  ;; Enable Corfu
  :config
  (global-corfu-mode))

;; Part of corfu
;; (use-package corfu-popupinfo
;;   :after corfu
;;   :ensure nil
;;   :hook (corfu-mode . corfu-popupinfo-mode)
;;   :custom
;;   (corfu-popupinfo-delay '(0.25 . 0.1))
;;   (corfu-popupinfo-hide nil)
;;   :config
;;   (corfu-popupinfo-mode))

;; Cape, or Completion At Point Extensions, extends the capabilities of
;; in-buffer completion. It integrates with Corfu or the default completion UI,
;; by providing additional backends through completion-at-point-functions.
(use-package cape
  :commands (cape-dabbrev cape-file cape-elisp-block)
  :bind ("C-c ." . cape-prefix-map)
  :init
  ;; Add to the global default value of `completion-at-point-functions' which is
  ;; used by `completion-at-point'.
  (add-hook 'completion-at-point-functions #'cape-dabbrev)
  (add-hook 'completion-at-point-functions #'cape-file)
  (add-hook 'completion-at-point-functions #'cape-elisp-block)
  (add-hook 'completion-at-point-functions #'cape-keyword)
  (add-hook 'completion-at-point-functions #'cape-history)
  )
#+end_src

** Company
http://company-mode.github.io/manual/Getting-Started.html

#+begin_src emacs-lispxx
(use-package company
  :diminish company-mode
  :hook
  (prog-mode . company-mode)
  (tex-mode . company-mode)
  (special-mode . company-mode)
  (comint-mode . company-mode)
  :bind
  (:map company-mode-map
        ("C-i" . company-complete)
        ("C-<space>" . company-complete))
  :bind
  (:map company-active-map
        ("<tab>" . company-complete-selection)
        ("TAB" . company-complete-selection))
  :config
  (setq company-minimum-prefix-length 1) ; 只需敲 1 个字母就开始进行自动补全
  (setq company-tooltip-align-annotations t)
  (setq company-idle-delay 0.0)
  (setq company-show-numbers t) ;; 给选项编号 (按快捷键 M-1、M-2 等等来进行选择).
  (setq company-selection-wrap-around t)
  (setq company-transformers '(company-sort-by-occurrence)) ; 根据选择的频率进行排序，读者如果不喜欢可以去掉
  )


(use-package company-posframe
  :config
  (company-posframe-mode 1))
#+end_src

** Vertico、Consult、Embark
#+begin_src emacs-lisp
;; Vertico provides a vertical completion interface, making it easier to
;; navigate and select from completion candidates (e.g., when `M-x` is pressed).
(use-package vertico
  ;; (Note: It is recommended to also enable the savehist package.)
  :bind (:map vertico-map
              ("<escape>" . #'minibuffer-keyboard-quit)
              ("RET" . vertico-directory-enter)
              ("DEL" . vertico-directory-delete-char))
  :init
  ;; (vertico-mouse-mode 1)
  (vertico-mode))

;; Vertico leverages Orderless' flexible matching capabilities, allowing users
;; to input multiple patterns separated by spaces, which Orderless then
;; matches in any order against the candidates.
(use-package orderless
  :custom
  (completion-styles '(orderless basic))
  (completion-category-defaults nil)
  (completion-category-overrides '((file (styles partial-completion)))))

;; Marginalia allows Embark to offer you preconfigured actions in more contexts.
;; In addition to that, Marginalia also enhances Vertico by adding rich
;; annotations to the completion candidates displayed in Vertico's interface.
(use-package marginalia
  :after vertico
  :commands (marginalia-mode marginalia-cycle)
  :hook (after-init . marginalia-mode))

;; Embark integrates with Consult and Vertico to provide context-sensitive
;; actions and quick access to commands based on the current selection, further
;; improving user efficiency and workflow within Emacs. Together, they create a
;; cohesive and powerful environment for managing completions and interactions.
(use-package embark
  ;; Embark is an Emacs package that acts like a context menu, allowing
  ;; users to perform context-sensitive actions on selected items
  ;; directly from the completion interface.
  :commands (embark-act
             embark-dwim
             embark-export
             embark-collect
             embark-bindings
             embark-prefix-help-command)
  :bind
  (("C-." . embark-act)         ;; pick some comfortable binding
   ("C-;" . embark-dwim)        ;; good alternative: M-.
   ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'

  :init
  (setq prefix-help-command #'embark-prefix-help-command)

  :config
  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none)))))

(use-package embark-consult
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))

;; Consult offers a suite of commands for efficient searching, previewing, and
;; interacting with buffers, file contents, and more, improving various tasks.
(use-package consult
  :bind (;; C-c bindings in `mode-specific-map'
         ("C-c M-x" . consult-mode-command)
         ("C-c h" . consult-history)
         ("C-c k" . consult-kmacro)
         ("C-c m" . consult-man)
         ("C-c i" . consult-info)
         ([remap Info-search] . consult-info)
         ;; ([remap apropos-command] . consult-apropos) ; C-h a
         ;; C-x bindings in `ctl-x-map'
         ("C-x M-:" . consult-complex-command)
         ([remap list-buffers] . consult-buffer)
         ("C-x 4 b" . consult-buffer-other-window)
         ("C-x 5 b" . consult-buffer-other-frame)
         ("C-x t b" . consult-buffer-other-tab)
         ("C-x r b" . consult-bookmark)
         ("C-x p b" . consult-project-buffer)
         ;; Custom M-# bindings for fast register access
         ("M-#" . consult-register-load)
         ("M-'" . consult-register-store)
         ("C-M-#" . consult-register)
         ;; Other custom bindings
         ("M-y" . consult-yank-pop)
         ;; M-g bindings in `goto-map'
         ("M-g e" . consult-compile-error)
         ("M-g f" . consult-flymake)
         ("M-g g" . consult-goto-line)
         ("M-g M-g" . consult-goto-line)
         ("M-g o" . consult-outline)
         ("M-g m" . consult-mark)
         ("M-g k" . consult-global-mark)
         ("M-g i" . consult-imenu)
         ("M-g I" . consult-imenu-multi)
         ;; M-s bindings in `search-map'
         ("M-s d" . consult-find)
         ("M-s c" . consult-locate)
         ("M-s g" . consult-grep)
         ("M-s G" . consult-git-grep)
         ("M-s r" . consult-ripgrep)
         ("M-s l" . consult-line)
         ("M-s L" . consult-line-multi)
         ("M-s k" . consult-keep-lines)
         ("M-s u" . consult-focus-lines)
         ;; Isearch integration
         ("M-s e" . consult-isearch-history)
         :map isearch-mode-map
         ("M-e" . consult-isearch-history)
         ("M-s e" . consult-isearch-history)
         ("M-s l" . consult-line)
         ("M-s L" . consult-line-multi)
         ;; Minibuffer history
         :map minibuffer-local-map
         ("M-s" . consult-history)
         ("M-r" . consult-history))

  ;; Enable automatic preview at point in the *Completions* buffer.
  :hook (completion-list-mode . consult-preview-at-point-mode)

  :init
  ;; Optionally configure the register formatting. This improves the register
  (setq register-preview-delay 0.5
        register-preview-function #'consult-register-format)

  ;; Optionally tweak the register preview window.
  (advice-add #'register-preview :override #'consult-register-window)

  ;; Use Consult to select xref locations with preview
  (setq xref-show-xrefs-function #'consult-xref
        xref-show-definitions-function #'consult-xref)

  ;; Aggressive asynchronous that yield instantaneous results. (suitable for
  ;; high-performance systems.) Note: Minad, the author of Consult, does not
  ;; recommend aggressive values.
  ;; Read: https://github.com/minad/consult/discussions/951
  ;;
  ;; However, the author of minimal-emacs.d uses these parameters to achieve
  ;; immediate feedback from Consult.
  ;; (setq consult-async-input-debounce 0.02
  ;;       consult-async-input-throttle 0.05
  ;;       consult-async-refresh-delay 0.02)

  :config
  (setq consult-narrow-key "<"))

;;----------------------------------------------------------------------------
;; Functions
;;----------------------------------------------------------------------------
;; Prefix the current candidate 箭头显示当前项
;; (defun minibuffer-format-candidate (orig cand prefix suffix index _start)
;;   (let ((prefix (if (= vertico--index index)
;;                     " » "
;;                   "   ")))
;;     (funcall orig cand prefix suffix index _start)))
;;
;; (advice-add #'vertico--format-candidate
;;             :around #'minibuffer-format-candidate)
#+end_src

** dabbrev
#+begin_src emacs-lisp
(use-package dabbrev
  :ensure nil
  ;; Swap M-/ and C-M-/
  :bind (("M-/" . dabbrev-completion)
         ("C-M-/" . dabbrev-expand))
  :config
  (add-to-list 'dabbrev-ignored-buffer-regexps "\\` ")
  ;; Since 29.1, use `dabbrev-ignored-buffer-regexps' on older.
  (add-to-list 'dabbrev-ignored-buffer-modes 'doc-view-mode)
  (add-to-list 'dabbrev-ignored-buffer-modes 'pdf-view-mode)
  (add-to-list 'dabbrev-ignored-buffer-modes 'tags-table-mode))
#+end_src

** Hippie Expand
hippie expand is dabbrev expand on steroids

#+begin_src emacs-lispxx
;; (global-set-key [remap dabbrev-expand] #'hippie-expand)
(setq hippie-expand-try-functions-list
      '(try-expand-dabbrev                 ;搜索当前 buffer, expand word "dynamically"
        try-expand-dabbrev-all-buffers     ;搜索所有 buffer
        try-expand-dabbrev-from-kill       ;从 kill-ring 中搜索
        try-complete-file-name-partially   ;文件名部分匹配
        try-complete-file-name             ;文件名匹配
        try-expand-all-abbrevs             ;匹配所有缩写词, according to all abbrev tables
        try-expand-list                    ;补全一个列表
        try-expand-line                    ;补全当前行
        try-complete-lisp-symbol-partially ;部分补全 lisp symbol
        try-complete-lisp-symbol))         ;补全 lisp symbol
#+end_src

** completion-preview-mode
#+begin_src emacs-lisp :tangle no
(add-hook 'prog-mode-hook #'completion-preview-mode)
(keymap-set completion-preview-active-mode-map "M-n" #'completion-preview-next-candidate)
(keymap-set completion-preview-active-mode-map "M-p" #'completion-preview-prev-candidate)
#+end_src

** Yasnippet
#+begin_src emacs-lisp :tangle no
;; The official collection of snippets for yasnippet.
(use-package yasnippet-snippets
  :ensure t
  :after yasnippet)

;; YASnippet is a template system designed that enhances text editing by
;; enabling users to define and use snippets. When a user types a short
;; abbreviation, YASnippet automatically expands it into a full template, which
;; can include placeholders, fields, and dynamic content.
(use-package yasnippet
  :ensure t
  :commands (yas-minor-mode
             yas-global-mode)

  :hook
  (after-init . yas-global-mode)

  :custom
  (yas-also-auto-indent-first-line t)  ; Indent first line of snippet
  (yas-also-indent-empty-lines t)
  (yas-snippet-revival nil)  ; Setting this to t causes issues with undo
  (yas-wrap-around-region nil) ; Do not wrap region when expanding snippets
  ;; (yas-triggers-in-field nil)  ; Disable nested snippet expansion
  ;; (yas-indent-line 'fixed) ; Do not auto-indent snippet content
  ;; (yas-prompt-functions '(yas-no-prompt))  ; No prompt for snippet choices

  :init
  ;; Suppress verbose messages
  (setq yas-verbosity 0))
#+end_src

** Tempel
#+begin_src emacs-lisp :tangle no
(use-package tempel
  :bind (("M-+" . tempel-complete)
         ("M-*" . tempel-insert)
         :map tempel-map
         ("M-]" . tempel-next)
         ("M-[" . tempel-previous)))

;; (use-package tempel-collection
;;   :after tempel)
#+end_src

* Version-Control
** Project
#+begin_src emacs-lisp
;; (define-key global-map (kbd "C-c p") project-prefix-map)

;; (use-package project
;;   :ensure nil
;;   :config
;;   ;; (setq project-switch-commands #'project-find-file)
;;   (setq project-switch-commands
;;         '((project-find-file "Find file" f)
;;           (project-dired "Dired" d)
;;           ;; (deadgrep "rg" r) # TODO
;;           (project-vc-dir "VC-Dir" v)
;;           (project-shell "Shell" s)
;;           (project-eshell "Eshell" e)
;;           (magit-project-status "Magit" ?m)))
;;   )

;; Transient menus for dispatching `project.el'
(use-package disproject
  :bind ( :map ctl-x-map
          ("p" . disproject-dispatch)
          :map global-map
          ("C-c p" . disproject-dispatch)))
#+end_src

** Magit
#+begin_src emacs-lisp
(use-package magit
  :bind
  (("C-c g" . magit-status)
   ("s-g" . magit-status))
  :custom
  (magit-format-file-function #'magit-format-file-nerd-icons)
  :config
  ;; Magit status fullscreen
  (setq magit-display-buffer-function #'magit-display-buffer-fullframe-status-v1)

  (when IS-WINDOWS
    (setq magit-refresh-status-buffer nil)
    (setq auto-revert-buffer-list-filter
          'magit-auto-revert-repository-buffer-p)
    (remove-hook 'magit-refs-sections-hook 'magit-insert-tags)
    (remove-hook 'server-switch-hook 'magit-commit-diff)
    (remove-hook 'with-editor-filter-visit-hook 'magit-commit-diff)))
#+end_src

** Git-gutter
#+begin_src emacs-lisp
(use-package git-gutter
  :diminish (git-gutter-mode)
  :custom
  (git-gutter:modified-sign  "~")
  (git-gutter:added-sign  "+")
  (git-gutter:deleted-sign  "-")
  :custom-face
  (git-gutter:modified  ((t (:background "#f1fa8c"))))
  (git-gutter:added  ((t (:background "#50fa7b"))))
  (git-gutter:deleted  ((t (:background "#ff79c6"))))
  :config
  (global-git-gutter-mode 1))
#+end_src

** Forge
#+begin_src emacs-lisp
(use-package forge
  :after magit)
#+end_src

** Git-timemachine
#+begin_src emacs-lisp
(use-package git-timemachine
  :commands  git-timemachine)
#+end_src

** Browse-at-remote
#+begin_src emacs-lisp
(use-package browse-at-remote
  :commands browser-at-remote)
#+end_src

** ediff
#+begin_src emacs-lisp
(use-package ediff
  :ensure nil
  :custom
  (ediff-custom-diff-options "-u"))
#+end_src

* Org
** org-mode
#+begin_src emacs-lisp
(use-package org
  :ensure nil
  :defer t
  :mode ("\\.org\\'" . org-mode)
  :bind(:map org-mode-map
             ("C-c a" . org-agenda)
             ("C-c x" . org-capture)
             ;; ("C-c l" . org-store-link)
             ("C-c C-j" . consult-outline)
             ("M-." . find-function-at-point))
  :config
  (setq
   ;; Start collapsed for speed
   org-startup-folded t
   ;; org-startup-indented t
   org-startup-truncated nil
   org-hide-leading-stars t
   org-refile-targets (quote ((nil :maxlevel . 9)
                              (org-agenda-files :maxlevel . 9)))

   ;; Edit settings
   org-support-shift-select t
   org-auto-align-tags nil
   org-tags-column 0
   org-catch-invisible-edits 'show-and-error
   org-special-ctrl-a/e t
   org-insert-heading-respect-content t

   ;; Org styling, hide markup etc.
   org-hide-emphasis-markers t
   org-pretty-entities t

  ;; Ellipsis styling
  ;; (setq org-ellipsis " ▼ ")
  org-ellipsis " \u25bc" ;; " ⤵" " ↴" " ➤" " ▼"
  ;; org-columns-default-format "%50ITEM(Task) %10CLOCKSUM %16TIMESTAMP_IA"
  ))
#+end_src

** org-babel
#+begin_src emacs-lisp
(setq org-src-fontify-natively t                ; Fontify code in code blocks.
      org-adapt-indentation nil                 ; Adaptive indentation
      org-src-tab-acts-natively t               ; Tab acts as in source editing
      org-confirm-babel-evaluate nil            ; No confirmation before executing code
      org-edit-src-content-indentation 0        ; No relative indentation for code blocks
      org-fontify-whole-block-delimiter-line t) ; Fontify whole block

(use-package org-auto-tangle
  :defer t
  :hook (org-mode . org-auto-tangle-mode))
#+end_src

** org-agenda
#+begin_src emacs-lisp :tangle no
(setq org-agenda-files (list "~/Documents/org/agenda.org"
                             "~/Documents/org/students.org"
                             "~/Documents/org/todo.org"
                             "~/Documents/org/inbox.org")
      org-agenda-diary-file (expand-file-name "diary" user-emacs-directory)

      ;; Agenda styling
      org-agenda-tags-column 0
      org-agenda-block-separator ?─
      org-agenda-time-grid
      '((daily today require-timed)
        (800 1000 1200 1400 1600 1800 2000)
        " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄")
      org-agenda-current-time-string
      "◀── now ─────────────────────────────────────────────────"
)
#+end_src

** org-super-agenda
https://github.com/alphapapa/org-super-agenda

** org-capture
emacsclient -n -c -e '(progn (select-frame-set-input-focus (selected-frame)) (org-capture))'

#+begin_src emacs-lisp
(setq org-capture-templates `(("t" "Tasks" entry (file+headline "tasks.org" "Reminders")
                            "* TODO %i%?"
                            :empty-lines-after 1
                            :prepend t)
                           ("n" "Notes" entry (file+headline "capture.org" "Notes")
                            "* %? %^g\n%i\n"
                            :empty-lines-after 1)
                           ;; For EWW
                           ("b" "Bookmarks" entry (file+headline "capture.org" "Bookmarks")
                            "* %:description\n\n%a%?"
                            :empty-lines 1
                            :immediate-finish t)
                           ("d" "Diary")
                           ("dt" "Today's TODO list" entry (file+olp+datetree "diary.org")
                            "* Today's TODO list [/]\n%T\n\n** TODO %?"
                            :empty-lines 1
                            :jump-to-captured t)
                           ("do" "Other stuff" entry (file+olp+datetree "diary.org")
                            "* %?\n%T\n\n%i"
                            :empty-lines 1
                            :jump-to-captured t)
                           ))
#+end_src

** org-modern
#+begin_src emacs-lisp
(use-package org-modern
  :disabled
  :after org
  :hook (org-mode . org-modern-mode))
#+end_src

** org-roam
https://zhuanlan.zhihu.com/p/633047823

#+begin_src emacs-lisp :tangle no
(use-package org-roam
  :custom
  (org-roam-directory (file-truename "~/Documents/org/"))
  :bind (("C-c n l" . org-roam-buffer-toggle)
         ("C-c n f" . org-roam-node-find)
         ("C-c n g" . org-roam-graph)
         ("C-c n i" . org-roam-node-insert)
         ("C-c n c" . org-roam-capture)
         ;; Dailies
         ("C-c n j" . org-roam-dailies-capture-today))
  :config
  ;; If you're using a vertical completion framework, you might want a more informative completion interface
  (setq org-roam-node-display-template (concat "${title:*} " (propertize "${tags:10}" 'face 'org-tag)))
  (org-roam-db-autosync-mode)
  ;; If using org-roam-protocol
  (require 'org-roam-protocol))
#+end_src

** org-apper
Make invisible parts of Org elements appear visible.

#+begin_src emacs-lisp
(use-package org-appear
  :hook (org-mode . org-appear-mode)
  :config
  (setq org-appear-autolinks t)
  (setq org-appear-autosubmarkers t)
  (setq org-appear-autoentities t)
  (setq org-appear-autokeywords t)
  (setq org-appear-inside-latex t)
  )
#+end_src

** denote :disable:
#+begin_src emacs-lisp :tangle no
(use-package denote
  :hook (dired-mode . denote-dired-mode-in-directories)
  :bind (("C-c d n" . denote)
         ("C-c d d" . denote-date)
         ("C-c d t" . denote-type)
         ("C-c d s" . denote-subdirectory)
         ("C-c d f" . denote-open-or-create)
         ("C-c d r" . denote-dired-rename-file))
  :init
  (with-eval-after-load 'org-capture
    (setq denote-org-capture-specifiers "%l\n%i\n%?")
    (add-to-list 'org-capture-templates
                 '("N" "New note (with denote.el)" plain
                   (file denote-last-path)
                   #'denote-org-capture
                   :no-save t
                   :immediate-finish nil
                   :kill-buffer t
                   :jump-to-captured t)))
  :config
  (setq denote-directory (expand-file-name "~/org/"))
  (setq denote-known-keywords '("emacs" "entertainment" "reading" "studying"))
  (setq denote-infer-keywords t)
  (setq denote-sort-keywords t)
  ;; org is default, set others such as text, markdown-yaml, markdown-toml
  (setq denote-file-type nil)
  (setq denote-prompts '(title keywords))

  ;; We allow multi-word keywords by default.  The author's personal
  ;; preference is for single-word keywords for a more rigid workflow.
  (setq denote-allow-multi-word-keywords t)
  (setq denote-date-format nil)

  ;; If you use Markdown or plain text files (Org renders links as buttons
  ;; right away)
  (add-hook 'find-file-hook #'denote-link-buttonize-buffer)
  (setq denote-dired-rename-expert nil)

  ;; OR if only want it in `denote-dired-directories':
  (add-hook 'dired-mode-hook #'denote-dired-mode-in-directories)
  )
#+end_src

** one.el
Static Site Generator for Emacs Lisp programmers.

https://one.tonyaldon.com/

** note-taking
https://github.com/kaorahi/howm

* LSP
** eglot
#+begin_src emacs-lisp
(use-package eglot
  :defer t
  :custom
  (eglot-autoshutdown t) ; shutdown after closing the last managed buffer
  (eglot-sync-connect 0) ; async, do not block
  (eglot-extend-to-xref t) ; can be interesting!
  :hook ((prog-mode . eglot-ensure))
  :config
  (add-to-list 'eglot-server-programs '(c-mode . ("clangd")))
  (add-to-list 'eglot-server-programs '(c++-mode . ("clangd")))
  (add-to-list 'eglot-server-programs '(go-mode . ("gopls")))
  (add-to-list 'eglot-server-programs '(python-mode . ("pylyzer" "--server")))
  (add-to-list 'eglot-server-programs '(rust-mode . ("rust-analyzer")))
  (add-to-list 'eglot-server-programs '(nix-mode . ("nixd")))
  (add-to-list 'eglot-server-programs '(markdown-mode . ("efm-langserver")))
  )

;; (use-package consult-eglot
;;   :after eglot)
#+end_src

** lsp-mode
#+begin_src emacs-lisp :tangle no
(use-package lsp-mode
  :init
  (defun my-lsp-hook ()
    "Do not use lsp-mode with tramp"
    (unless (file-remote-p default-directory)
      (lsp)))
  :config
  (setq lsp-idle-delay 0.5
        lsp-enable-symbol-highlighting t
        lsp-headerline-breadcrumb-enable nil
        lsp-enable-snippet nil)
  :hook ((python-mode . my-lsp-hook)
         (f90-mode . my-lsp-hook)
         (haskell-mode . my-lsp-hook)
         (lsp-mode . lsp-enable-which-key-integration)))

(use-package lsp-ui
  :hook (lsp-mode . lsp-ui-mode)
  :config
  (setq lsp-ui-sideline-enable nil
        lsp-ui-doc-header nil
        lsp-ui-doc-delay 0.5
        lsp-ui-doc-position 'bottom
        lsp-ui-doc-alignment 'frame
        lsp-ui-doc-include-signature t
        lsp-ui-doc-use-childframe t)
  :commands lsp-ui-mode)
#+end_src

** lsp-booster
https://github.com/blahgeek/emacs-lsp-booster

** lsp-proxy
https://github.com/jadestrong/lsp-proxy

** apheleia
Run code formatters on ~after-save-hook~

#+begin_src emacs-lisp
(use-package apheleia
  :defer t
  :commands (apheleia-mode
             apheleia-global-mode)
  :hook ((prog-mode . apheleia-mode)))
#+end_src

** reformatter
#+begin_src emacs-lispxx
(use-package reformatter
  :defer t
  :config
  (reformatter-define nixfmt
    :program "nixfmt"
    )
  ;; Experimental.
  ;; (reformatter-define golint
  ;;   :program "golint"
  ;;   :stdin nil
  ;;   :stdout nil
  ;;   :args (list (buffer-file-name)))
  )
#+end_src

* Programming
** prog-mode
#+begin_src emacs-lisp
(add-hook 'prog-mode-hook
          (lambda ()
            (hl-line-mode)              ;高亮当前行
            (whitespace-mode)           ;显示空格
            (display-line-numbers-mode) ;显示行号
            ;; word-wrap
            (setq word-wrap nil)        ;在任意字符处拆分单词换行
            (setq truncate-lines nil)   ;启用行截断
            ))
#+end_src

** compilation
#+begin_src emacs-lisp
(setq compilation-ask-about-save nil  ;Just save before compiling
      compilation-always-kill t       ;kill old compile processes before new one
      compilation-scroll-output 'first-error ; Automatically scroll to first error
      )
#+end_src

** flycheck
#+begin_src emacs-lisp
(use-package flycheck
  :defer t
  :diminish " ✓"
  :hook (prog-mode . flycheck-mode)
  :init
  ;; disable flycheck in some mode
  (setq flycheck-disabled-checkers '(
                                     emacs-lisp
                                     emacs-lisp-checkdoc
                                     sh-shellscript
                                     )))
#+end_src

** flymake
#+begin_src emacs-lisp
(use-package flymake
  :disabled
  :hook (prog-mode . flymake-mode)
  :bind ( :map my-error-map
          ("l" . flymake-show-buffer-diagnostics)
          ("L" . flymake-show-project-diagnostics)
          ("n" . flymake-goto-next-error)
          ("p" . flymake-goto-prev-error))
  :init
  (setq-default flymake-no-changes-timeout 1.0))
#+end_src

** dape
https://github.com/svaante/dape

** quick-run
#+begin_src emacs-lisp
(use-package quickrun
  :defer t)
#+end_src

** editorconfig
#+begin_src emacs-lisp
(editorconfig-mode t)
#+end_src

** tree-sitter
#+begin_src emacs-lisp
(use-package treesit-auto
  :when (eq system-type 'gnu/linux)
  ; :custom
  ; (treesit-auto-install 'prompt)
  :config
  (treesit-auto-add-to-auto-mode-alist 'all)
  (global-treesit-auto-mode))
#+end_src

** lua
#+begin_src emacs-lisp
(use-package lua-mode
  :mode ("\\.lua'"))
#+end_src

** sql
#+begin_src emacs-lisp
(use-package sql-indent
  :mode ("\\.sql\\'")
  :interpreter (("sql" . sql-mode)))

;; (use-package sqlformat
;;   :init
;;   (setq sqlformat-command "sqlfluff"))
#+end_src

** dockerfile
#+begin_src emacs-lisp
(use-package dockerfile-mode
  :mode ("Dockerfile\\'"))
#+end_src

** powershell
#+begin_src emacs-lisp
(use-package powershell
  :mode ("\\.ps1'"))
#+end_src

** python
#+begin_src emacs-lisp
(use-package python-mode
  :mode ("\\.py\\'")
  :config
  (setq python-indent-offset 4
        python-indent 4
        indent-tabs-mode nil
        default-tab-width 4
        python-shell-interpreter "python3"))

;; (use-package live-py-mode)

;; (use-package lsp-python-ms
;;   :hook (python-mode . (lambda ()
;;                           (require 'lsp-python-ms)
;;                           (lsp))))
                                        ; or lsp-deferred
#+end_src

** go
#+begin_src emacs-lisp
(use-package go-mode
  :commands go-mode
  :config
  (setq gofmt-command "goimports")
  (add-hook 'before-save-hook 'gofmt-before-save))
#+end_src

** rust
#+begin_src emacs-lisp
(use-package rustic
  :mode "\\.rs$"
  :custom
  (rustic-format-display-method 'ignore) ; Rustfmtのメッセージをポップアップしない
  (rustic-format-trigger 'on-save)
  :after flycheck
  :config
  (push 'rustic-clippy flycheck-checkers))

(use-package cargo-transient
  :custom
  (cargo-transient-buffer-name-function #'project-prefixed-buffer-name))
#+end_src

** ruby
#+begin_src emacs-lisp
  ;; (use-package ruby-mode
  ;;   :defvar ruby-mode-map
  ;;   :custom (ruby-insert-encoding-magic-comment . nil)
  ;;   :hook (ruby-mode-hook . lsp)
  ;;   :config
  ;;   (dvorak-set-key-prog ruby-mode-map)
  ;;   (use-package inf-ruby
  ;;     :hook (ruby-mode-hook . inf-ruby-minor-mode)))
#+end_src

** C
#+begin_src emacs-lisp :tangle no
(use-package cc-mode
  :bind (:map c-mode-base-map
              ("<f12>" . compile))
  :init (setq-default c-basic-offset 4))

(use-package ccls
  :defer t
  :hook ((c-mode c++-mode objc-mode cuda-mode) . lsp)
  :commands lsp)
#+end_src

** java & android
#+begin_src emacs-lisp
(use-package groovy-mode)
#+end_src

** haskell
#+begin_src emacs-lisp :tangle no
(use-package haskell-mode
  :init
  (setq flymake-allowed-file-name-masks nil)
  :custom
  (haskell-process-load-or-reload-prompt t)
  (haskell-process-auto-import-loaded-modules t)
  (haskell-process-log t)
  (haskell-tags-on-save t))

(use-package lsp-haskell)
#+end_src

** elisp
#+begin_src emacs-lisp
(use-package elisp-mode
  :ensure nil
  :hook (elisp-mode . (lambda () (setq mode-name "ξ ")))
  ;; :bind (:map elisp-mode-map
  ;;             ("C-c e" . fc-eval-and-replace))
  )

(use-package slime
  :commands slime)

(use-package macrostep
  :bind (:map elisp-mode-map
              ("C-c e" . macrostep-expand)
              :map lisp-interaction-mode-map
              ("C-c e" . macrostep-expand)))
#+end_src

** paredit、aggressive-indent、highlight-defined
#+begin_src emacs-lispxx
;; Prevent parenthesis imbalance
(use-package paredit
  :ensure t
  :commands paredit-mode
  :hook
  (emacs-lisp-mode . paredit-mode)
  :config
  (define-key paredit-mode-map (kbd "RET") nil))

;; Displays visible indicators for page breaks
(use-package page-break-lines
  :ensure t
  :commands (page-break-lines-mode
             global-page-break-lines-mode)
  :hook
  (emacs-lisp-mode . page-break-lines-mode))

;; Provides functions to find references to functions, macros, variables,
;; special forms, and symbols in Emacs Lisp
(use-package elisp-refs
  :ensure t
  :commands (elisp-refs-function
             elisp-refs-macro
             elisp-refs-variable
             elisp-refs-special
             elisp-refs-symbol))

;; Enables automatic indentation of code while typing
(use-package aggressive-indent
  :ensure t
  :commands aggressive-indent-mode
  :hook
  (emacs-lisp-mode . aggressive-indent-mode))

;; Highlights function and variable definitions in Emacs Lisp mode
(use-package highlight-defined
  :ensure t
  :commands highlight-defined-mode
  :hook
  (emacs-lisp-mode . highlight-defined-mode))
#+end_src

** nix
#+begin_src emacs-lisp
(use-package nix-mode
  :mode ("\\.nix'"))

;; (use-package direnv
;;   :when (eq system-type 'gnu/linux) ; Windows unsupport
;;   :config
;;   (direnv-mode))
#+end_src

* Web-Dev
** basic
#+begin_src emacs-lisp :tangle no
(use-package css-mode
  :ensure nil
  :init (setq css-indent-offset 2))

(use-package scss-mode
  :init
  ;; Disable complication on save
  (setq scss-compile-at-save nil))

(unless (fboundp 'less-css-mode)
  (use-package less-css-mode))

;; nxml
(use-package nxml-mode
  :ensure nil
  :mode (("\\.xaml$" . xml-mode)))

(use-package php-mode
  :mode "\\.php$")

(use-package typescript-mode
  :mode ("\\.ts[x]\\'" . typescript-mode))

;; JavaScript
(use-package js-mode
  :ensure nil
  :defines (js-indent-level flycheck-javascript-eslint-executable)
  :config
  (setq js-indent-level 2)

  (with-eval-after-load 'flycheck
    ;; https://github.com/mantoni/eslint_d.js
    ;; Install: npm -i -g eslint_d
    (when (executable-find "eslint_d")
      (setq flycheck-javascript-eslint-executable "eslint_d"))))


(use-package js2-mode
  :mode (("\\.js\\'" . js2-mode)
         ("\\.jsx\\'" . js2-jsx-mode))
  :interpreter (("node" . js2-mode)
                ("node" . js2-jsx-mode))
  :hook ((js2-mode . js2-imenu-extras-mode)
         (js2-mode . js2-highlight-unused-variables-mode))
  :config
  (with-eval-after-load 'flycheck
    (when (or (executable-find "eslint_d")
              (executable-find "eslint")
              (executable-find "jshint"))
      (setq js2-mode-show-strict-warnings nil))))


;; Adds node_modules/.bin directory to `exec_path'
(use-package add-node-modules-path
  :hook ((web-mode js-mode js2-mode) . add-node-modules-path))

(use-package web-mode
  :mode ("\\.[agj]sp\\'"
         "\\.as[cp]x\\'"
         "\\.djhtml\\'"
         "\\.ejs\\'"
         "\\.erb\\'"
         "\\.html?\\'"
         "\\.jsx?\\'"
         "\\.mjsx?\\'"
         "\\.mustache\\'"
         "\\.php\\'"
         "\\.phtml\\'"
         "\\.tpl\\'"
         "\\.tsx?\\'"
         "\\.vue\\'")
  :config
  (setq web-mode-markup-indent-offset 2
        web-mode-css-indent-offset 2
        web-mode-code-indent-offset 2
        web-mode-indent-style 2))
#+end_src

** conf-mode
#+begin_src emacs-lisp
(use-package conf-mode
  :mode
  "/credentials$" "\\.accept_keywords$"
  "\\lfrc$" "\\.keywords$" "\\.license$"
  "\\.mask$" "\\.unmask$" "\\.use$")
(global-set-key [remap conf-space-keywords] #'project-find-file)
#+end_src

** prettier :disable:
HTML/CSS/TS/JSON/YAML/MARKDOWN

#+begin_src emacs-lispxx
(use-package prettier
  :diminish
  :hook ((js-mode js2-mode css-mode sgml-mode web-mode) . prettier-mode)
  :init (setq prettier-pre-warm 'none))
#+end_src

** markdown
#+begin_src emacs-lisp
(use-package markdown-mode
  :config
  (setq markdown-hide-urls nil
        markdown-fontify-code-blocks-natively t)
  :mode (("\\.md\\'" . gfm-mode)
         ("README\\'" . gfm-mode)))

(use-package markdown-preview-mode
  :defer t)
#+end_src

** json
#+begin_src emacs-lisp
(use-package json-mode
  :mode ("\\.json'"))

(use-package json-reformat
  :commands json-reformat-region)

(use-package json-navigator
  :commands json-navigator-navigate-region)

(use-package ox-json
  :defer t)
#+end_src

** yaml
#+begin_src emacs-lisp
(use-package yaml-pro
  :mode ("\\.yml'" "\\.yaml'"))
#+end_src

** toml
#+begin_src emacs-lisp
(use-package toml-mode
  :mode ("\\.toml'"))
#+end_src

** kdl
#+begin_src emacs-lisp
(use-package kdl-mode
  :mode ("\\.kdl'"))
#+end_src

** just
#+begin_src emacs-lisp
(use-package just-mode
  :mode ("\\.just'" "justfile\\'"))
#+end_src

** license-templates
#+begin_src emacs-lisp
(use-package license-templates
  :defer t)
#+end_src

* Functions
** make-parent-directory
#+begin_src emacs-lisp
;;;###autoload
(defun make-parent-directory ()
  "Make sure the directory of `buffer-file-name' exists."
  (make-directory (file-name-directory buffer-file-name) t))
(add-hook 'find-file-not-found-functions #'make-parent-directory)
#+end_src

** space to newline
#+begin_src emacs-lisp
;;;###autoload
(defun my/space-to-newline ()
  "Replace space sequence to a newline char.
Works on current block or selection.

URL `http://ergoemacs.org/emacs/emacs_space_to_newline.html'
Version 2017-08-19"
  (interactive)
  (let* ( $p1 $p2 )
    (if (use-region-p)
        (progn
          (setq $p1 (region-beginning))
          (setq $p2 (region-end)))
      (save-excursion
        (if (re-search-backward "\n[ \t]*\n" nil "move")
            (progn (re-search-forward "\n[ \t]*\n")
                   (setq $p1 (point)))
          (setq $p1 (point)))
        (re-search-forward "\n[ \t]*\n" nil "move")
        (skip-chars-backward " \t\n" )
        (setq $p2 (point))))
    (save-excursion
      (save-restriction
        (narrow-to-region $p1 $p2)
        (goto-char (point-min))
        (while (re-search-forward " +" nil t)
          (replace-match "\n" ))))))
#+end_src

** insert-timestamp
#+begin_src emacs-lisp
;;;###autoload
(defun my/insert-timestamp ()
  "Insert string for the current time."
  (interactive)
  (insert (format-time-string "[%02y-%02m-%02d %02H:%02M:%02S] ")))
#+end_src

** backward-delete-word
~M-backspace~ 删除而非剪切

#+begin_src emacs-lisp
;;;###autoload
(defun backward-delete-word (arg)
  "Delete characters backward until encountering the beginning of a word.
  With argument ARG, do this that many times."
  (interactive "p")
  (delete-region (point) (progn (backward-word arg) (point))))
(global-set-key [remap backward-kill-word] #'backward-delete-word)
#+end_src

** proxy
https://github.com/seagle0128/.emacs.d/blob/master/lisp/init-funcs.el#L663

#+begin_src emacs-lisp
;;;###autoload
(defun my/toggle-url-proxy ()
  "Toggle proxy for the url.el library."
  (interactive)
  (cond
   (url-proxy-services
    (message "URL proxy turn off")
    (setq url-proxy-services nil))
   (t
    (message "URL proxy turn on")
    (setq url-proxy-services
          '(("http" . "localhost:7890")
            ("https" . "localhost:7890")
            ("no_proxy" . "^\\(localhost\\|192.168.*\\|10.*\\)"))))))
#+end_src

** pkill-emacs
#+begin_src emacs-lisp
;;;###autoload
(defun my/pkill-emacs ()
  (interactive)
  (progn
    (save-buffers-kill-emacs)
    (shell-command-to-string "pkill -i emacs")))
#+end_src

* Keybindings
** bind-keys
#+begin_src emacs-lisp
(which-key-mode)
(ffap-bindings) ;find-file-at-point, smarter C-x C-f when point on path or URL

(bind-keys
 ;; Built-in: M-s
 :map search-map
 ("s" . deadgrep)
 ("<SPC>" . consult-line)
 ("l" . consult-line)
 ("L" . consult-line-multi)
 ("g" . consult-grep)
 ("f" . consult-fd)
 ("r" . consult-ripgrep)
 ("p" . consult-isearch-history))

(bind-keys*
 ;; ("C-z" . nil) ;unbind C-z
 ("C-z" . undo)
 ("C-S-z" . undo-redo)
 ("C-s" . consult-line)
 ;; ("C-." . company-complete)
 ("C-." . hippie-expand)
 ("C-/" . comment-line) ;vscode
 ("C-\\" . align-regexp)
 ("C-x \\" . toggle-input-method)
 ("C-S-i" . eglot-format) ;vscode
 ("C-S-t" . tab-new)
 ("C-x C-r" . recentf)
 ([remap kill-buffer] . kill-current-buffer)

 ;; doom-like
 ("C-c <SPC>" . project-find-file)
 ("C-c C-<SPC>" . project-find-file)
 ;; ("C-c ." . find-file)
 ("C-c /" . consult-ripgrep)
 ("C-c ," . project-switch-to-buffer)
 ("C-x b" . project-switch-to-buffer)
 ;; ("C-<tab>" . project-switch-to-buffer)

 ("M-+" . text-scale-increase)
 ("M-_" . text-scale-decrease)

 ("C-x 2" . (lambda()
              (interactive)
              (split-window-below)
              (select-window (next-window))))
 ("C-x 3" . (lambda()
              (interactive)
              (split-window-right)
              (select-window (next-window))))

 ("C-x 4 x" . ace-swap-window)

 ("<f7>" . compile)
 ("<C-f7>" . (lambda()
               (interactive)
               (save-buffer)
               (recompile)))

 :prefix-map buffer-map
 :prefix "C-c b"
 ("i" . ibuffer)
 ("b" . consult-buffer)
 ("k". kill-current-buffer)
 ("r" . revert-buffer)
 ("s" . save-some-buffers)
 ("D" . crux-delete-file-and-buffer)
 ("<f2>" . rename-visited-file)

 :prefix-map file-map
 :prefix "C-c f"
 ("o" . crux-open-with)
 ("s" . save-some-buffers)
 ("u" . crux-sudo-edit)
 ("D" . crux-delete-file-and-buffer)
 ("<f2>" . rename-visited-file)

 :prefix-map window-map
 :prefix "C-c w"
 ("]" . ace-swap-window)
 ("\\" . rotate-layout)
 ("s" . easysession-save-as)
 ("l" . easysession-load)
 ("X" . easysession-reset)
 ("D" . easysession-delete)
 ("<SPC>" . easysession-switch-to)

 :prefix-map mark-map
 :prefix "C-c m"
 ;; ("'" . er/mark-inside-quotes)
 ;; ("[" . er/mark-inside-pairs)
 ("l" . goto-last-change)
 ("m" . bm-toggle)
 ("0" . bm-remove-all-current-buffer)

 ;; org-mode-map
 ;; :prefix-map code-map
 ;; :prefix "C-c c"
 ;; ("." . consult-lsp-diagnostics)

 :prefix-map lsp-map
 :prefix "C-c l"
 ("f" . eglot-format)

 :prefix-map git-mode
 :prefix "C-c v"
 ("/" . magit-dispatch)
 ("." . magit-file-dispatch)
 ("L" . magit-log-buffer-file)
 ("b" . magit-blame-addition)
 ("t" . git-timemachine)
 ("o" . browse-at-remote)
 ("f" . forge-dispatch)

 :prefix-map remove-map
 :prefix "C-c -"
 ("b" . bookmark-delete)
 ("r" . recentf-edit-list)
 ("p" . project-forget-project)

 :prefix-map toggle-map
 :prefix "C-c t"
 ("c" . global-display-fill-column-indicator-mode)
 ("f" . flycheck)
 ("z" . writeroom-mode)
 ("p" . perfect-margin)
 ("i" . indent-bars-mode)
 ("k" . keycast)
 ("u" . disk-usage)
 )
#+end_src

** Mouse
M-x ~describe-key~

#+begin_src emacs-lisp
(fset 'mouse-save-then-kill 'ignore) ;禁用鼠标右键双击剪切
(global-unset-key (kbd "<mouse-2>")) ;禁用鼠标中键
(global-unset-key (kbd "C-<wheel-up>"))
(global-unset-key (kbd "C-<wheel-down>"))
;; 禁用 mouse-drag-region
;; (global-unset-key [M-mouse-1])
(global-unset-key [M-drag-mouse-1])
(global-unset-key [M-down-mouse-1])
(global-unset-key [M-mouse-3])
;; disable mouse in minibuffer echo area
(keymap-unset minibuffer-inactive-mode-map "<mouse-1>")

;; 禁用所有鼠标
(use-package inhibit-mouse
  :disabled
  :config
  (if (daemonp)
      (add-hook 'server-after-make-frame-hook #'inhibit-mouse-mode)
    (inhibit-mouse-mode 1)))

;; Scroll
(pixel-scroll-precision-mode t)
;; (use-package ultra-scroll
;;   :vc (:url "https://github.com/jdtsmith/ultra-scroll"
;;             :rev :newest)
;;   :init
;;   (setq scroll-conservatively 101 ; important!
;;         scroll-margin 0)
;;   :config
;;   (ultra-scroll-mode 1))
#+end_src

** casual
https://github.com/kickingvegas/casual

#+begin_src emacs-lisp
(use-package casual
  :bind (("C-c o" . #'casual-editkit-main-tmenu)
         :map dired-mode-map ("C-o" . casual-dired-tmenu)
         :map isearch-mode-map ("C-o" . casual-isearch-tmenu)
         :map calc-mode-map ("C-o" . casual-calc-tmenu)
         :map Info-mode-map ("C-o" . casual-info-tmenu)))
#+end_src

** view-mode
#+begin_src emacs-lisp
(use-package view
  :ensure nil
  :bind (:map view-mode-map
              ("j" . next-line)
              ("k" . previous-line)
              ("h" . backward-char)
              ("l" . forward-char)
              ("g" . goto-line)
              ("b" . View-scroll-page-backward))
  :config
  (setq view-read-only t))
#+end_src

** devil
#+begin_src emacs-lisp :tangle no
(use-package devil
  :config
  (global-devil-mode)
  (global-set-key (kbd "C-,") 'global-devil-mode))
#+end_src

** keycast
Show current command and its binding.

#+begin_src emacs-lisp
(use-package keycast
  :defer t)
#+end_src

** rime
#+begin_src emacs-lisp
(use-package rime
  :custom
  (default-input-method "rime"))
#+end_src

* Footer
#+begin_src emacs-lisp
(provide 'post-init.el)
;;; post-init.el ends here
#+end_src

* Links
- https://remacs.fun/posts/ 面向产品经理的 Emacs 教程
- https://github.com/LionyxML/emacs-solo Pure Emacs (no external packages)
- https://github.com/seagle0128/.emacs.d Centaur Emacs
- https://github.com/abougouffa/minemacs Minemacs
- https://github.com/Lambda-Emacs/lambda-emacs Lambda-emacs
- https://github.com/rougier/dotemacs Litterate configuration org
- https://jansky520.github.io/p/org%E5%BF%AB%E9%80%9F%E6%8C%87%E5%8D%97/ org 快速指南
- https://orgmode.org/quickstart.html
- https://orgmode.org/manual/Working-with-Source-Code.html
- https://jwiegley.github.io/use-package/keywords/
   
